%
% (c) Zachari Khayati Darian
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{merasem-avaz}
\RequirePackage{fontspec,setspace,stackengine,varwidth,luacode,luatexbase,merasem-common}

\providecommand\defaulthxostext{á¼®Ï‡Î¿Ï‚}
\providecommand\hxosfonthook{\greekfont}
\providecommand\texthxos[4][\defaulthxostext]{{
  \unskip\let\naefaes\empty\ruh
  \unskip\let\NeumeFontScaleFactor\NeumeFontScaleFactorHxos\NeumeAutoResize
  {\hxosfonthook #1 }
  {\neume #2}
  {\hxosfonthook #3 }
  {\neume #4 }
}}
\providecommand\hxos[4][\defaulthxostext]{{\let\helper\empty\decree{\texthxos[#1]{#2}{#3}{#4}}}}
\providecommand\smallhxos[4][\defaulthxostext]{{
  \setlength\parskip{0.5\parskip}
  \setstretch{0.6}
  \hxos[#1]{#2}{#3}{#4}
}}
\newlength\NeumeAlignment
\newlength\NeumePadding
\newlength\NeumeTextPadding
\newlength\NeumeComboPadding

\providecommand\NeumeFontScaleFactor{5}
\providecommand\NeumeFontScaleFactorHxos{2.6}
\providecommand\NeumeFontScaleFactorInline{2.4}
\providecommand\NeumeAlignmentScaleFactor{-0.2}
\providecommand\NeumePaddingScaleFactor{0}
\providecommand\NeumeTextPaddingScaleFactor{0}
\providecommand\NeumeComboPaddingScaleFactor{0}
\providecommand\DropcapScaleFactor{5.5}
\providecommand\NeumeAutoResize{
  \unskip\setlength\tmpFontSize{\f@size pt}
  \unskip\setlength\NeumeFontSize    {\NeumeFontScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeAlignment   {\NeumeAlignmentScaleFactor\tmpFontSize}
  \unskip\setlength\NeumePadding     {\NeumePaddingScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeTextPadding {\NeumeTextPaddingScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeComboPadding{\NeumeComboPaddingScaleFactor\tmpFontSize}
  \unskip\ignorespaces
}
\providecommand\dropfont{}
\providecommand\neumedropcommand[1]{{\leavevmode
  \unskip\NeumeAutoResize
  \unskip\dropfont\scshape\ruh\fontsize{\DropcapScaleFactor\tmpFontSize}
  {\DropcapScaleFactor\tmpFontSize}\selectfont\ignorespaces #1 \unskip\hspace{-\NeumeAlignment}\ignorespaces
}}
\providecommand\dropmpair[2][]{{\leavevmode
  \unskip\storefirstletter #1
  \unskip\neumedropcommand{\firstletter}
  \unskip\musicpair[\scshape\firstletterremainder]{\ignorespaces #2 \unskip}\ignorespaces
}}
\providecommand\ULmuspair[2][]{\musicpair[#1\_]{#2}}
\newfontface\NeumeFont{SERAFIM+} % https://psaltiki.info
\newlength\tmpFontSize
\newlength\NeumeFontSize
\newlength\tmpStackFontSize
\NeumeAutoResize
\providecommand\musicpair[2][]{
  \unskip\renewcommand\stackalignment{c}
  \unskip\renewcommand\stacktype{L}
  \unskip\stackon{\strut\hspace{0.5\NeumeTextPadding}
  \unskip\ignorespaces #1 \unskip\hspace{0.5\NeumeTextPadding}}{
    \unskip{\neume\strut\hspace{\NeumeAlignment}\hspace{0.5\NeumePadding}
    \unskip\ignorespaces #2 \unskip\hspace{-\NeumeAlignment}\hspace{0.5\NeumePadding}}\ignorespaces
  }\hspace{\NeumeComboPadding}{ }\ignorespaces
}
\providecommand\annotate[2]{
  \unskip\renewcommand\stacktype{S}
  \unskip\renewcommand\stackalignment{l}
  \unskip\setlength\tmpStackFontSize{\f@size pt}
  \unskip\stackon{\ignorespaces #1 \unskip}{
    \unskip\fontsize{0.5\tmpStackFontSize}{0.5\tmpStackFontSize}\selectfont
    \unskip\begin{varwidth}[t][5ex][t]{\textwidth}
      \unskip\ \\*[-2ex]
      \unskip\ruh{\ignorespaces #2 \unskip}
    \unskip\end{varwidth}\ignorespaces
  }\ignorespaces
}
\providecommand\IsokratimaHook{\ruh}
\newenvironment{byzmacros}{
  \unskip\def\daseia{ğ€}
  \unskip\def\perispomeni{ğ€‚}
  \unskip\def\oxeiaekfonitikon{ğ€ƒ}
  \unskip\def\oxeiadipli{ğ€„}
  \unskip\def\vareiaekfonitikon{ğ€…}
  \unskip\def\vareiadipli{ğ€†}
  \unskip\def\kathisti{ğ€‡}
  \unskip\def\syrmatiki{ğ€ˆ}
  \unskip\def\paraklitiki{ğ€‰}
  \unskip\def\ypokrisis{ğ€Š}
  \unskip\def\ypokrisisdipli{ğ€‹}
  \unskip\def\kremasti{ğ€Œ}
  \unskip\def\apesoekfonitikon{ğ€}
  \unskip\def\exoekfonitikon{ğ€}
  \unskip\def\teleia{ğ€}
  \unskip\def\kntaek{ğ€}
  \unskip\def\apostrofos{ğ€‘}
  \unskip\def\apostrofosdipli{ğ€’}
  \unskip\def\synevma{ğ€“}
  \unskip\def\thita{ğ€”}
  \unskip\def\oligarchaion{ğ€•}
  \unskip\def\gorgonarchaion{ğ€–}
  \unskip\def\psilon{ğ€—}
  \unskip\def\chamilon{ğ€˜}
  \unskip\def\vathy{ğ€™}
  \unskip\def\isarchaion{ğ€š}
  \unskip\def\knarchaion{ğ€›}
  \unskip\def\kntaekarchaion{ğ€œ}
  \unskip\def\saximata{ğ€}
  \unskip\def\parichon{ğ€}
  \unskip\def\stavrosapodexia{ğ€Ÿ}
  \unskip\def\oxeiaarchaion{ğ€ }
  \unskip\def\vareiaiarchaion{ğ€¡}
  \unskip\def\apodermaarchaion{ğ€¢}
  \unskip\def\apothema{ğ€£}
  \unskip\def\klasma{ğ€¤}
  \unskip\def\revma{ğ€¥}
  \unskip\def\piasmaarchaion{ğ€¦}
  \unskip\def\tinagma{ğ€§}
  \unskip\def\anatrichisma{ğ€¨}
  \unskip\def\seisma{ğ€©}
  \unskip\def\synagmaarchaion{ğ€ª}
  \unskip\def\synagmametastavrou{ğ€«}
  \unskip\def\oyranismaarchaion{ğ€¬}
  \unskip\def\thema{ğ€­}
  \unskip\def\lemoi{ğ€®}
  \unskip\def\dyo{ğ€¯}
  \unskip\def\tria{ğ€°}
  \unskip\def\tessera{ğ€±}
  \unskip\def\kratimata{ğ€²}
  \unskip\def\apesoexoneo{ğ€³}
  \unskip\def\fthoraarchaion{ğ€´}
  \unskip\def\imifthora{ğ€µ}
  \unskip\def\tromikonarchaion{ğ€¶}
  \unskip\def\katavatromikon{ğ€·}
  \unskip\def\pelaston{ğ€¸}
  \unskip\def\psifistonar{ğ€¹}
  \unskip\def\kontevma{ğ€º}
  \unskip\def\chorevmaarchaion{ğ€»}
  \unskip\def\rapisma{ğ€¼}
  \unskip\def\parakalesmaarchaion{ğ€½}
  \unskip\def\paraklitikiarchaion{ğ€¾}
  \unskip\def\ichadin{ğ€¿}
  \unskip\def\nana{ğ€}
  \unskip\def\petasma{ğ}
  \unskip\def\kontevmaallo{ğ‚}
  \unskip\def\tromikonallo{ğƒ}
  \unskip\def\straggismata{ğ„}
  \unskip\def\gronthismata{ğ…}
  \unskip\def\is{ğ†}
  \unskip\def\olig{ğ‡}
  \unskip\def\oksia{ğˆ}
  \unskip\def\pet{ğ‰}
  \unskip\def\koufisma{ğŠ}
  \unskip\def\petastokoufisma{ğ‹}
  \unskip\def\kratimokoufisma{ğŒ}
  \unskip\def\pelastonneo{ğ}
  \unskip\def\ypsiliaristera{ğ}
  \unskip\def\ypsilimeso{ğ}
  \unskip\def\ypsili{ğ}
  \unskip\def\apo{ğ‘}
  \unskip\def\apostrofoisyndesmosneo{ğ’}
  \unskip\def\yp{ğ“}
  \unskip\def\kratimoyporroon{ğ”}
  \unskip\def\el{ğ•}
  \unskip\def\xa{ğ–}
  \unskip\def\mikronis{ğ—}
  \unskip\def\var{ğ˜}
  \unskip\def\piasmaneo{ğ™}
  \unskip\def\psifiston{ğš}
  \unskip\def\omalon{ğ›}
  \unskip\def\antikenoma{ğœ}
  \unskip\def\lygisma{ğ}
  \unskip\def\paraklitikineo{ğ}
  \unskip\def\parakalesmaneo{ğŸ}
  \unskip\def\eteron{ğ }
  \unskip\def\kylisma{ğ¡}
  \unskip\def\antikenokylisma{ğ¢}
  \unskip\def\tromikonneo{ğ£}
  \unskip\def\ekstrepton{ğ¤}
  \unskip\def\synagmaneo{ğ¥}
  \unskip\def\syrma{ğ¦}
  \unskip\def\chorevmaneo{ğ§}
  \unskip\def\epegerma{ğ¨}
  \unskip\def\seismaneo{ğ©}
  \unskip\def\xironklasma{ğª}
  \unskip\def\tromikopsifiston{ğ«}
  \unskip\def\psifistolygisma{ğ¬}
  \unskip\def\tromikolygisma{ğ­}
  \unskip\def\tromikoparakalesma{ğ®}
  \unskip\def\psifistoparakalesma{ğ¯}
  \unskip\def\tromikosynagma{ğ°}
  \unskip\def\psifistosynagma{ğ±}
  \unskip\def\gorgosyntheton{ğ²}
  \unskip\def\argosyntheton{ğ³}
  \unskip\def\eteronargosyntheton{ğ´}
  \unskip\def\oyranismaneo{ğµ}
  \unskip\def\thematismaseso{ğ¶}
  \unskip\def\thematismosexo{ğ·}
  \unskip\def\themaaploun{ğ¸}
  \unskip\def\theskaiapothes{ğ¹}
  \unskip\def\katavasma{ğº}
  \unskip\def\endofonon{ğ»}
  \unskip\def\yfenkato{ğ¼}
  \unskip\def\yfenano{ğ½}
  \unskip\def\stavros{ğ¾}
  \unskip\def\klasmaano{ğ¿}
  \unskip\def\dipliar{ğ‚€}
  \unskip\def\kratimaarchaion{ğ‚}
  \unskip\def\kratimaallo{ğ‚‚}
  \unskip\def\kratimaneo{ğ‚ƒ}
  \unskip\def\apodermaneo{ğ‚„}
  \unskip\def\apli{ğ‚…}
  \unskip\def\dipli{ğ‚†}
  \unskip\def\tripli{ğ‚‡}
  \unskip\def\tetrapli{ğ‚ˆ}
  \unskip\def\koronisbyz{ğ‚‰}
  \unskip\def\leimmaenoschronou{ğ‚Š}
  \unskip\def\leimmadyochronon{ğ‚‹}
  \unskip\def\leimmatrionchronon{ğ‚Œ}
  \unskip\def\leimmatessaronchronon{ğ‚}
  \unskip\def\leimmaimiseoschronou{ğ‚}
  \unskip\def\gorgon{{\naefaes ğ‚}}
  \unskip\def\gorgonparestigmenonaristera{{\naefaesğ‚}}
  \unskip\def\gorgonparestigmenondexia{{\naefaesğ‚‘}}
  \unskip\def\digorgon{{\naefaes ğ‚’}}
  \unskip\def\digorgparestigmaristerkato{{\naefaesğ‚“}}
  \unskip\def\digorgparestigmaristerano{{\naefaesğ‚”}}
  \unskip\def\digorgonparestigmenondexia{{\naefaesğ‚•}}
  \unskip\def\trigorgon{{\naefaes ğ‚–}}
  \unskip\def\argon{{\naefaesğ‚—}}
  \unskip\def\imidiargon{{\naefaesğ‚˜}}
  \unskip\def\diargon{{\naefaesğ‚™}}
  \unskip\def\agogipoliargi{{\naefaesğ‚š}}
  \unskip\def\agogiargoteri{{\naefaesğ‚›}}
  \unskip\def\agogiargi{{\naefaesğ‚œ}}
  \unskip\def\agogimetria{{\naefaesğ‚}}
  \unskip\def\anooksia{{\naefaesğ‚}}
  \unskip\def\agogigorgi{{\naefaesğ‚Ÿ}}
  \unskip\def\agogigorgoteri{{\naefaesğ‚ }}
  \unskip\def\agogipoligorgi{{\naefaesğ‚¡}}
  \unskip\def\mpa{{\naefaes ğ‚¢}}
  \unskip\def\mp{{\naefaes ğ‚£}}
  \unskip\def\mda{{\naefaes ğ‚¤}}
  \unskip\def\mdb{{\naefaes ğ‚¥}}
  \unskip\def\mt{{\naefaes ğ‚¦}}
  \unskip\def\mtri{{\naefaes ğ‚§}}
  \unskip\def\mtet{{\naefaes ğ‚¨}}
  \unskip\def\mleg{{\naefaes ğ‚©}}
  \unskip\def\mlegetos{{\naefaes ğ‚ª}}
  \unskip\def\mpl{{\naefaes ğ‚«}}
  \unskip\def\istelichi{{\naefaes ğ‚¬}}
  \unskip\def\mapos{{\naefaes ğ‚­}}
  \unskip\def\fantetra{{\naefaes ğ‚®}}
  \unskip\def\fanmono{{\naefaes ğ‚¯}}
  \unskip\def\fandifon{{\naefaes ğ‚°}}
  \unskip\def\mvar{{\naefaes ğ‚±}}
  \unskip\def\mprotovarys{{\naefaes ğ‚²}}
  \unskip\def\mpltet{{\naefaes ğ‚³}}
  \unskip\def\moda{ğ‚´}
  \unskip\def\modb{ğ‚µ}
  \unskip\def\fb{{\naefaes ğ‚¶}}
  \unskip\def\imifonon{{\naefaes ğ‚·}}
  \unskip\def\imifthoron{{\naefaes ğ‚¸}}
  \unskip\def\fda{{\naefaes ğ‚¹}}
  \unskip\def\fp{{\naefaes ğ‚º}}
  \unskip\def\fg{{\naefaes ğ‚»}}
  \unskip\def\naos{{\naefaes ğ‚¼}}
  \unskip\def\fd{{\naefaes ğ‚½}}
  \unskip\def\ms{{\naefaes ğ‚¾}}
  \unskip\def\fk{{\naefaes ğ‚¿}}
  \unskip\def\fz{{\naefaes ğƒ€}}
  \unskip\def\fn{{\naefaes ğƒ}}
  \unskip\def\fna{{\naefaes ğƒ‚}}
  \unskip\def\fm{{\naefaes ğƒƒ}}
  \unskip\def\mm{{\naefaes ğƒ„}}
  \unskip\def\fs{{\naefaes ğƒ…}}
  \unskip\def\fmk{{\naefaes ğƒ†}}
  \unskip\def\fnenano{{\naefaes ğƒ‡}}
  \unskip\def\chrzygos{{\naefaes ğƒˆ}}
  \unskip\def\chrkliton{{\naefaes ğƒ‰}}
  \unskip\def\chrspathi{{\naefaes ğƒŠ}}
  \unskip\def\fen{{\naefaes ğƒ‹}}
  \unskip\def\fenantifonia{{\naefaes ğƒŒ}}
  \unskip\def\omalonapo{ğƒ}
  \unskip\def\omalonol{ğƒ}
  \unskip\def\omalonkn{ğƒ}
  \unskip\def\d{{\naefaes ğƒ}}
  \unskip\def\dd{{\naefaes ğƒ‘}}
  \unskip\def\ddd{{\naefaes ğƒ’}}
  \unskip\def\dddd{{\naefaes ğƒ“}}
  \unskip\def\y{{\naefaes ğƒ”}}
  \unskip\def\yy{{\naefaes ğƒ•}}
  \unskip\def\yyy{{\naefaes ğƒ–}}
  \unskip\def\yyyy{{\naefaes ğƒ—}}
  \unskip\def\genikidiesis{{\naefaes ğƒ˜}}
  \unskip\def\genikiyfesis{{\naefaes ğƒ™}}
  \unskip\def\diastolimikri{{\naefaes ğƒš}}
  \unskip\def\diastoli{{\naefaes ğƒ›}}
  \unskip\def\diastolidipli{{\naefaes ğƒœ}}
  \unskip\def\diastolitheseos{{\naefaes ğƒ}}
  \unskip\def\ism{{\IsokratimaHookğƒ}}
  \unskip\def\isd{{\IsokratimaHookğƒŸ}}
  \unskip\def\isk{{\IsokratimaHookğƒ }}
  \unskip\def\isz{{\IsokratimaHookğƒ¡}}
  \unskip\def\isn{{\IsokratimaHookğƒ¢}}
  \unskip\def\isp{{\IsokratimaHookğƒ£}}
  \unskip\def\isB{{\IsokratimaHookğƒ¤}}
  \unskip\def\isG{{\IsokratimaHookğƒ¥}}
  \unskip\def\isD{{\IsokratimaHookğƒ¦}}
  \unskip\def\isK{{\IsokratimaHookğƒ§}}
  \unskip\def\isZ{{\IsokratimaHookğƒ¨}}
  \unskip\def\apa{{\naefaes ğƒ©}}
  \unskip\def\avu{{\naefaes ğƒª}}
  \unskip\def\aga{{\naefaes ğƒ«}}
  \unskip\def\adi{{\naefaes ğƒ¬}}
  \unskip\def\ake{{\naefaes ğƒ­}}
  \unskip\def\azo{{\naefaes ğƒ®}}
  \unskip\def\ani{{\naefaes ğƒ¯}}
  \unskip\def\knta{ğƒ°}
  \unskip\def\kn{ğƒ±}
  \unskip\def\kntakato{ğƒ²}
  \unskip\def\knkato{ğƒ³}
  \unskip\def\klasmakato{ğƒ´}
  \unskip\def\gorgonkato{ğƒµ}
  \unskip\def\zwj{â€}
  \unskip\def\wj{â }
  \unskip\def\zwsp{â€‹}
  \unskip\ignorespaces
}{}
\newenvironment{troparion}{}{}
\newenvironment{neume}{
  \unskip\fontsize{\NeumeFontSize}{\NeumeFontSize}\NeumeFont
  \unskip\byzmacros\ignorespaces
}{\unskip\ignorespaces}

%% Lua-side code
\begin{luacode}
function NeumeParseUnicode ( line )
    line = string.gsub ( line , "ğ‚", "\\gorgon" )
    line = string.gsub ( line , "ğ‚", "\\gorgonparestigmenonaristera" )
    line = string.gsub ( line , "ğ‚‘", "\\gorgonparestigmenondexia" )
    line = string.gsub ( line , "ğ‚’", "\\digorgon" )
    line = string.gsub ( line , "ğ‚“", "\\digorgparestigmaristerkato" )
    line = string.gsub ( line , "ğ‚”", "\\digorgparestigmaristerano" )
    line = string.gsub ( line , "ğ‚•", "\\digorgonparestigmenondexia" )
    line = string.gsub ( line , "ğ‚–", "\\trigorgon" )
    line = string.gsub ( line , "ğ‚—", "\\argon" )
    line = string.gsub ( line , "ğ‚˜", "\\imidiargon" )
    line = string.gsub ( line , "ğ‚™", "\\diargon" )
    line = string.gsub ( line , "ğ‚š", "\\agogipoliargi" )
    line = string.gsub ( line , "ğ‚›", "\\agogiargoteri" )
    line = string.gsub ( line , "ğ‚œ", "\\agogiargi" )
    line = string.gsub ( line , "ğ‚", "\\agogimetria" )
    line = string.gsub ( line , "ğ‚", "\\anooksia" )
    line = string.gsub ( line , "ğ‚Ÿ", "\\agogigorgi" )
    line = string.gsub ( line , "ğ‚ ", "\\agogigorgoteri" )
    line = string.gsub ( line , "ğ‚¡", "\\agogipoligorgi" )
    line = string.gsub ( line , "ğ‚¢", "\\mpa" )
    line = string.gsub ( line , "ğ‚£", "\\mp" )
    line = string.gsub ( line , "ğ‚¤", "\\mda" )
    line = string.gsub ( line , "ğ‚¥", "\\mdb" )
    line = string.gsub ( line , "ğ‚¦", "\\mt" )
    line = string.gsub ( line , "ğ‚§", "\\mtri" )
    line = string.gsub ( line , "ğ‚¨", "\\mtet" )
    line = string.gsub ( line , "ğ‚©", "\\mleg" )
    line = string.gsub ( line , "ğ‚ª", "\\mlegetos" )
    line = string.gsub ( line , "ğ‚«", "\\mpl" )
    line = string.gsub ( line , "ğ‚¬", "\\istelichi" )
    line = string.gsub ( line , "ğ‚­", "\\mapos" )
    line = string.gsub ( line , "ğ‚®", "\\fantetra" )
    line = string.gsub ( line , "ğ‚¯", "\\fanmono" )
    line = string.gsub ( line , "ğ‚°", "\\fandifon" )
    line = string.gsub ( line , "ğ‚±", "\\mvar" )
    line = string.gsub ( line , "ğ‚²", "\\mprotovarys" )
    line = string.gsub ( line , "ğ‚³", "\\mpltet" )
    line = string.gsub ( line , "ğ‚¶", "\\fb" )
    line = string.gsub ( line , "ğ‚·", "\\imifonon" )
    line = string.gsub ( line , "ğ‚¸", "\\imifthoron" )
    line = string.gsub ( line , "ğ‚¹", "\\fda" )
    line = string.gsub ( line , "ğ‚º", "\\fp" )
    line = string.gsub ( line , "ğ‚»", "\\fg" )
    line = string.gsub ( line , "ğ‚¼", "\\naos" )
    line = string.gsub ( line , "ğ‚½", "\\fd" )
    line = string.gsub ( line , "ğ‚¾", "\\ms" )
    line = string.gsub ( line , "ğ‚¿", "\\fk" )
    line = string.gsub ( line , "ğƒ€", "\\fz" )
    line = string.gsub ( line , "ğƒ", "\\fn" )
    line = string.gsub ( line , "ğƒ‚", "\\fna" )
    line = string.gsub ( line , "ğƒƒ", "\\fm" )
    line = string.gsub ( line , "ğƒ„", "\\mm" )
    line = string.gsub ( line , "ğƒ…", "\\fs" )
    line = string.gsub ( line , "ğƒ†", "\\fmk" )
    line = string.gsub ( line , "ğƒ‡", "\\fnenano" )
    line = string.gsub ( line , "ğƒˆ", "\\chrzygos" )
    line = string.gsub ( line , "ğƒ‰", "\\chrkliton" )
    line = string.gsub ( line , "ğƒŠ", "\\chrspathi" )
    line = string.gsub ( line , "ğƒ‹", "\\fen" )
    line = string.gsub ( line , "ğƒŒ", "\\fenantifonia" )
    line = string.gsub ( line , "ğƒ", "\\d" )
    line = string.gsub ( line , "ğƒ‘", "\\dd" )
    line = string.gsub ( line , "ğƒ’", "\\ddd" )
    line = string.gsub ( line , "ğƒ“", "\\dddd" )
    line = string.gsub ( line , "ğƒ”", "\\y" )
    line = string.gsub ( line , "ğƒ•", "\\yy" )
    line = string.gsub ( line , "ğƒ–", "\\yyy" )
    line = string.gsub ( line , "ğƒ—", "\\yyyy" )
    line = string.gsub ( line , "ğƒ˜", "\\genikidiesis" )
    line = string.gsub ( line , "ğƒ™", "\\genikiyfesis" )
    line = string.gsub ( line , "ğƒš", "\\diastolimikri" )
    line = string.gsub ( line , "ğƒ›", "\\diastoli" )
    line = string.gsub ( line , "ğƒœ", "\\diastolidipli" )
    line = string.gsub ( line , "ğƒ", "\\diastolitheseos" )
    line = string.gsub ( line , "ğƒ", "\\ism" )
    line = string.gsub ( line , "ğƒŸ", "\\isd" )
    line = string.gsub ( line , "ğƒ ", "\\isk" )
    line = string.gsub ( line , "ğƒ¡", "\\isz" )
    line = string.gsub ( line , "ğƒ¢", "\\isn" )
    line = string.gsub ( line , "ğƒ£", "\\isp" )
    line = string.gsub ( line , "ğƒ¤", "\\isB" )
    line = string.gsub ( line , "ğƒ¥", "\\isG" )
    line = string.gsub ( line , "ğƒ¦", "\\isD" )
    line = string.gsub ( line , "ğƒ§", "\\isK" )
    line = string.gsub ( line , "ğƒ¨", "\\isZ" )
    line = string.gsub ( line , "ğƒ©", "\\apa" )
    line = string.gsub ( line , "ğƒª", "\\avu" )
    line = string.gsub ( line , "ğƒ«", "\\aga" )
    line = string.gsub ( line , "ğƒ¬", "\\adi" )
    line = string.gsub ( line , "ğƒ­", "\\ake" )
    line = string.gsub ( line , "ğƒ®", "\\azo" )
    line = string.gsub ( line , "ğƒ¯", "\\ani" )
    return ( line )
end
\end{luacode}

%% TeX-side code
\newenvironment{NeumeParseUnicode}{%
   \directlua{luatexbase.add_to_callback(
              "process_input_buffer",
              NeumeParseUnicode, "NeumeParseUnicode")}}{%
   \directlua{luatexbase.remove_from_callback(
              "process_input_buffer",
              "NeumeParseUnicode")}}
