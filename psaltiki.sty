% Ãelou! KÃ¡evarju dÃºing?  This is my first package ever and if it is
% beneficial to you, then I am very happy, my frjÃ©nding.
%
% (c) AnastÃ¡zius KaejatÃ­ DariÃ¡n
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{psaltiki}
\RequirePackage{fontspec,stackengine,varwidth}

\@ifpackageloaded{xcolor}{\providecommand\ruh{\color{red}}}{}
\@ifpackageloaded{luacolor}{\providecommand\ruh{\color{red}}}{}
\providecommand\ruh{}

\newcommand\needspacecommandwrapper[1]{}
\@ifpackageloaded{needspace}{
  \renewcommand\needspacecommandwrapper[1]{\Needspace*{#1}}
}{}
\newcommand\hxos[4][á¼¯Ï‡Î¿Ï‚]{
  \needspacecommandwrapper{6\baselineskip}
  {\centering\ruh
  \renewcommand\NeumeFontScaleFactor{2.5}\NeumeAutoResize
  #1
  {\neume #2}
  #3
  {\neume #4}
  \par
  }\nopagebreak
}
\newcommand\NeumeFontScaleFactor{5}
\newcommand\NeumeAutoResize{
  \setlength\tmpFontSize{\f@size pt}
  \setlength\NeumeFontSize{\NeumeFontScaleFactor\tmpFontSize}
}
\newfontface\NeumeFont{SERAFIM+}
\newlength\tmpFontSize
\newlength\NeumeFontSize
\NeumeAutoResize
\newlength\NeumeStackSpace\setlength\NeumeStackSpace{-0.65em}
\newcommand{\neumestack}[2][]{
  \renewcommand\stacktype{L}
  \stackon{\strut#1}{
    {\neume\strut#2}
  }\hspace{\NeumeStackSpace}
}
\newcommand{\annotate}[2]{
  \renewcommand\stacktype{S}
  \setlength\tmpFontSize{\f@size pt}
  \stackon{#2}{
    \fontsize{0.5\tmpFontSize}{0.5\tmpFontSize}\selectfont
    \begin{varwidth}[t][5ex][t]{\textwidth}
      \ \\*[-2ex]
      \ruh #1
    \end{varwidth}
  }
}
\newenvironment{byzmacros}{
  \def\daseia{ğ€}
  \def\perispomeni{ğ€‚}
  \def\oxeiaekfonitikon{ğ€ƒ}
  \def\oxeiadipli{ğ€„}
  \def\vareiaekfonitikon{ğ€…}
  \def\vareiadipli{ğ€†}
  \def\kathisti{ğ€‡}
  \def\syrmatiki{ğ€ˆ}
  \def\paraklitiki{ğ€‰}
  \def\ypokrisis{ğ€Š}
  \def\ypokrisisdipli{ğ€‹}
  \def\kremasti{ğ€Œ}
  \def\apesoekfonitikon{ğ€}
  \def\exoekfonitikon{ğ€}
  \def\teleia{ğ€}
  \def\kntaek{ğ€}
  \def\apostrofos{ğ€‘}
  \def\apostrofosdipli{ğ€’}
  \def\synevma{ğ€“}
  \def\thita{ğ€”}
  \def\oligarchaion{ğ€•}
  \def\gorgonarchaion{ğ€–}
  \def\psilon{ğ€—}
  \def\chamilon{ğ€˜}
  \def\vathy{ğ€™}
  \def\isarchaion{ğ€š}
  \def\knarchaion{ğ€›}
  \def\kntaekarchaion{ğ€œ}
  \def\saximata{ğ€}
  \def\parichon{ğ€}
  \def\stavrosapodexia{ğ€Ÿ}
  \def\oxeiaarchaion{ğ€ }
  \def\vareiaiarchaion{ğ€¡}
  \def\apodermaarchaion{ğ€¢}
  \def\apothema{ğ€£}
  \def\klasma{ğ€¤}
  \def\revma{ğ€¥}
  \def\piasmaarchaion{ğ€¦}
  \def\tinagma{ğ€§}
  \def\anatrichisma{ğ€¨}
  \def\seisma{ğ€©}
  \def\synagmaarchaion{ğ€ª}
  \def\synagmametastavrou{ğ€«}
  \def\oyranismaarchaion{ğ€¬}
  \def\thema{ğ€­}
  \def\lemoi{ğ€®}
  \def\dyo{ğ€¯}
  \def\tria{ğ€°}
  \def\tessera{ğ€±}
  \def\kratimata{ğ€²}
  \def\apesoexoneo{ğ€³}
  \def\fthoraarchaion{ğ€´}
  \def\imifthora{ğ€µ}
  \def\tromikonarchaion{ğ€¶}
  \def\katavatromikon{ğ€·}
  \def\pelaston{ğ€¸}
  \def\psifistonar{ğ€¹}
  \def\kontevma{ğ€º}
  \def\chorevmaarchaion{ğ€»}
  \def\rapisma{ğ€¼}
  \def\parakalesmaarchaion{ğ€½}
  \def\paraklitikiarchaion{ğ€¾}
  \def\ichadin{ğ€¿}
  \def\nana{ğ€}
  \def\petasma{ğ}
  \def\kontevmaallo{ğ‚}
  \def\tromikonallo{ğƒ}
  \def\straggismata{ğ„}
  \def\gronthismata{ğ…}
  \def\is{ğ†}
  \def\olig{ğ‡}
  \def\oksia{ğˆ}
  \def\pet{ğ‰}
  \def\koufisma{ğŠ}
  \def\petastokoufisma{ğ‹}
  \def\kratimokoufisma{ğŒ}
  \def\pelastonneo{ğ}
  \def\ypsiliaristera{ğ}
  \def\ypsilimeso{ğ}
  \def\ypsili{ğ}
  \def\apo{ğ‘}
  \def\apostrofoisyndesmosneo{ğ’}
  \def\yp{ğ“}
  \def\kratimoyporroon{ğ”}
  \def\el{ğ•}
  \def\xa{ğ–}
  \def\mikronis{ğ—}
  \def\var{ğ˜}
  \def\piasmaneo{ğ™}
  \def\psifiston{ğš}
  \def\omalon{ğ›}
  \def\antikenoma{ğœ}
  \def\lygisma{ğ}
  \def\paraklitikineo{ğ}
  \def\parakalesmaneo{ğŸ}
  \def\eteron{ğ }
  \def\kylisma{ğ¡}
  \def\antikenokylisma{ğ¢}
  \def\tromikonneo{ğ£}
  \def\ekstrepton{ğ¤}
  \def\synagmaneo{ğ¥}
  \def\syrma{ğ¦}
  \def\chorevmaneo{ğ§}
  \def\epegerma{ğ¨}
  \def\seismaneo{ğ©}
  \def\xironklasma{ğª}
  \def\tromikopsifiston{ğ«}
  \def\psifistolygisma{ğ¬}
  \def\tromikolygisma{ğ­}
  \def\tromikoparakalesma{ğ®}
  \def\psifistoparakalesma{ğ¯}
  \def\tromikosynagma{ğ°}
  \def\psifistosynagma{ğ±}
  \def\gorgosyntheton{ğ²}
  \def\argosyntheton{ğ³}
  \def\eteronargosyntheton{ğ´}
  \def\oyranismaneo{ğµ}
  \def\thematismaseso{ğ¶}
  \def\thematismosexo{ğ·}
  \def\themaaploun{ğ¸}
  \def\theskaiapothes{ğ¹}
  \def\katavasma{ğº}
  \def\endofonon{ğ»}
  \def\yfenkato{ğ¼}
  \def\yfenano{ğ½}
  \def\stavros{ğ¾}
  \def\klasmaano{ğ¿}
  \def\dipliar{ğ‚€}
  \def\kratimaarchaion{ğ‚}
  \def\kratimaallo{ğ‚‚}
  \def\kratimaneo{ğ‚ƒ}
  \def\apodermaneo{ğ‚„}
  \def\apli{ğ‚…}
  \def\dipli{ğ‚†}
  \def\tripli{ğ‚‡}
  \def\tetrapli{ğ‚ˆ}
  \def\koronisbyz{ğ‚‰}
  \def\leimmaenoschronou{ğ‚Š}
  \def\leimmadyochronon{ğ‚‹}
  \def\leimmatrionchronon{ğ‚Œ}
  \def\leimmatessaronchronon{ğ‚}
  \def\leimmaimiseoschronou{ğ‚}
  \def\gorgon{{\ruh ğ‚}}
  \def\gorgonparestigmenonaristera{{\ruhğ‚}}
  \def\gorgonparestigmenondexia{{\ruhğ‚‘}}
  \def\digorgon{{\ruh ğ‚’}}
  \def\digorgparestigmaristerkato{{\ruhğ‚“}}
  \def\digorgparestigmaristerano{{\ruhğ‚”}}
  \def\digorgonparestigmenondexia{{\ruhğ‚•}}
  \def\trigorgon{{\ruh ğ‚–}}
  \def\argon{{\ruhğ‚—}}
  \def\imidiargon{{\ruhğ‚˜}}
  \def\diargon{{\ruhğ‚™}}
  \def\agogipoliargi{{\ruhğ‚š}}
  \def\agogiargoteri{{\ruhğ‚›}}
  \def\agogiargi{{\ruhğ‚œ}}
  \def\agogimetria{{\ruhğ‚}}
  \def\anooksia{{\ruhğ‚}}
  \def\agogigorgi{{\ruhğ‚Ÿ}}
  \def\agogigorgoteri{{\ruhğ‚ }}
  \def\agogipoligorgi{{\ruhğ‚¡}}
  \def\mpa{{\ruh ğ‚¢}}
  \def\mp{{\ruh ğ‚£}}
  \def\mda{{\ruh ğ‚¤}}
  \def\mdb{{\ruh ğ‚¥}}
  \def\mt{{\ruh ğ‚¦}}
  \def\mtri{{\ruh ğ‚§}}
  \def\mtet{{\ruh ğ‚¨}}
  \def\mleg{{\ruh ğ‚©}}
  \def\mlegetos{{\ruh ğ‚ª}}
  \def\mpl{{\ruh ğ‚«}}
  \def\istelichi{{\ruh ğ‚¬}}
  \def\mapos{{\ruh ğ‚­}}
  \def\fantetra{{\ruh ğ‚®}}
  \def\fanmono{{\ruh ğ‚¯\hspace{0.2em}}}
  \def\fandifon{{\ruh ğ‚°}}
  \def\mvar{{\ruh ğ‚±}}
  \def\mprotovarys{{\ruh ğ‚²}}
  \def\mpltet{{\ruh ğ‚³}}
  \def\moda{ğ‚´}
  \def\modb{ğ‚µ}
  \def\fb{{\ruh ğ‚¶}}
  \def\imifonon{{\ruh ğ‚·}}
  \def\imifthoron{{\ruh ğ‚¸}}
  \def\fda{{\ruh ğ‚¹}}
  \def\fp{{\ruh ğ‚º}}
  \def\fg{{\ruh ğ‚»}}
  \def\naos{{\ruh ğ‚¼}}
  \def\fd{{\ruh ğ‚½}}
  \def\ms{{\ruh ğ‚¾}}
  \def\fk{{\ruh ğ‚¿}}
  \def\fz{{\ruh ğƒ€}}
  \def\fn{{\ruh ğƒ}}
  \def\fna{{\ruh ğƒ‚}}
  \def\fm{{\ruh ğƒƒ}}
  \def\mm{{\ruh ğƒ„}}
  \def\fs{{\ruh ğƒ…}}
  \def\fmk{{\ruh ğƒ†}}
  \def\fnenano{{\ruh ğƒ‡}}
  \def\chrzygos{{\ruh ğƒˆ}}
  \def\chrkliton{{\ruh ğƒ‰}}
  \def\chrspathi{{\ruh ğƒŠ}}
  \def\fen{{\ruh ğƒ‹}}
  \def\fenantifonia{{\ruh ğƒŒ}}
  \def\omalonapo{ğƒ}
  \def\omalonol{ğƒ}
  \def\omalonkn{ğƒ}
  \def\d{{\ruh ğƒ}}
  \def\dd{{\ruh ğƒ‘}}
  \def\ddd{{\ruh ğƒ’}}
  \def\dddd{{\ruh ğƒ“}}
  \def\y{{\ruh ğƒ”}}
  \def\yy{{\ruh ğƒ•}}
  \def\yyy{{\ruh ğƒ–}}
  \def\yyyy{{\ruh ğƒ—}}
  \def\genikidiesis{{\ruh ğƒ˜}}
  \def\genikiyfesis{{\ruh ğƒ™}}
  \def\diastolimikri{{\ruh ğƒš}}
  \def\diastoli{{\ruh ğƒ›}}
  \def\diastolidipli{{\ruh ğƒœ}}
  \def\diastolitheseos{{\ruh ğƒ}}
  \def\ism{{\ruhğƒ}}
  \def\isd{{\ruhğƒŸ}}
  \def\isk{{\ruhğƒ }}
  \def\isz{{\ruhğƒ¡}}
  \def\isn{{\ruhğƒ¢}}
  \def\isp{{\ruhğƒ£}}
  \def\isB{{\ruhğƒ¤}}
  \def\isG{{\ruhğƒ¥}}
  \def\isD{{\ruhğƒ¦}}
  \def\isK{{\ruhğƒ§}}
  \def\isZ{{\ruhğƒ¨}}
  \def\apa{{\ruh ğƒ©}}
  \def\avu{{\ruh ğƒª}}
  \def\aga{{\ruh ğƒ«}}
  \def\adi{{\ruh ğƒ¬}}
  \def\ake{{\ruh ğƒ­}}
  \def\azo{{\ruh ğƒ®}}
  \def\ani{{\ruh ğƒ¯}}
  \def\knta{ğƒ°}
  \def\kn{ğƒ±}
  \def\kntakato{ğƒ²}
  \def\knkato{ğƒ³}
  \def\klasmakato{ğƒ´}
  \def\gorgonkato{ğƒµ}
  \def\zwj{â€}
  \def\wj{â }
  \def\zwsp{â€‹}
}{}
\newenvironment{troparion}{}{}
\newenvironment{neume}{
  \fontsize{\NeumeFontSize}{\NeumeFontSize}\NeumeFont
  \byzmacros
}{}

\ExplSyntaxOn
\tl_new:N \l__blackened_test_tl
\@ifpackageloaded{luacolor}
{
  \NewDocumentEnvironment{NeumeColor}{+b}
  {
    \tl_set:Nn \l__blackened_test_tl { #1 }
    % TODO
      \regex_replace_all:nnN{NEUMESYMBOL}{\c{NEUMENAME}}\l__blackened_test_tl
    \tl_use:N \l__blackened_test_tl
  }{}
  \ExplSyntaxOff
}{\newenvironment{NeumeColor}{}{}}
