% Áelou! Káevarju dúing?  This is my first package ever and if it is
% beneficial to you, then I am very happy, my frjénding.
%
% (c) Anastázius Kaejatí Darián
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{psaltiki}
\RequirePackage{fontspec,stackengine,varwidth,luacode,luatexbase}

\@ifpackageloaded{xcolor}{\providecommand\ruh{\color{red}}}{}
\@ifpackageloaded{luacolor}{\providecommand\ruh{\color{red}}\providecommand\nruh{\ruh}}{}
\providecommand\ruh{}\providecommand\nruh{}

\newcommand\needspacecommandwrapper[1]{}
\@ifpackageloaded{needspace}{
  \renewcommand\needspacecommandwrapper[1]{\Needspace*{#1}}
}{}
\newcommand\hxos[4][Ἧχος]{
  \needspacecommandwrapper{6\baselineskip}
  {\centering\ruh
  \renewcommand\NeumeFontScaleFactor{2.5}\NeumeAutoResize
  #1
  {\neume #2}
  #3
  {\neume #4}
  \par
  }\nopagebreak
}
\newcommand\NeumeFontScaleFactor{5}
\newcommand\NeumeAutoResize{
  \setlength\tmpFontSize{\f@size pt}
  \setlength\NeumeFontSize{\NeumeFontScaleFactor\tmpFontSize}
}
\newfontface\NeumeFont{SERAFIM+}
\newlength\tmpFontSize
\newlength\NeumeFontSize
\NeumeAutoResize
\newlength\NeumeStackSpace\setlength\NeumeStackSpace{-0.65em}
\newcommand{\neumestack}[2][]{
  \renewcommand\stacktype{L}
  \stackon{\strut#1}{
    {\neume\strut#2}
  }\hspace{\NeumeStackSpace}
}
\newcommand{\annotate}[2]{
  \renewcommand\stacktype{S}
  \setlength\tmpFontSize{\f@size pt}
  \stackon{#2}{
    \fontsize{0.5\tmpFontSize}{0.5\tmpFontSize}\selectfont
    \begin{varwidth}[t][5ex][t]{\textwidth}
      \ \\*[-2ex]
      \ruh #1
    \end{varwidth}
  }
}
\newenvironment{byzmacros}{
  \def\daseia{𝀁}
  \def\perispomeni{𝀂}
  \def\oxeiaekfonitikon{𝀃}
  \def\oxeiadipli{𝀄}
  \def\vareiaekfonitikon{𝀅}
  \def\vareiadipli{𝀆}
  \def\kathisti{𝀇}
  \def\syrmatiki{𝀈}
  \def\paraklitiki{𝀉}
  \def\ypokrisis{𝀊}
  \def\ypokrisisdipli{𝀋}
  \def\kremasti{𝀌}
  \def\apesoekfonitikon{𝀍}
  \def\exoekfonitikon{𝀎}
  \def\teleia{𝀏}
  \def\kntaek{𝀐}
  \def\apostrofos{𝀑}
  \def\apostrofosdipli{𝀒}
  \def\synevma{𝀓}
  \def\thita{𝀔}
  \def\oligarchaion{𝀕}
  \def\gorgonarchaion{𝀖}
  \def\psilon{𝀗}
  \def\chamilon{𝀘}
  \def\vathy{𝀙}
  \def\isarchaion{𝀚}
  \def\knarchaion{𝀛}
  \def\kntaekarchaion{𝀜}
  \def\saximata{𝀝}
  \def\parichon{𝀞}
  \def\stavrosapodexia{𝀟}
  \def\oxeiaarchaion{𝀠}
  \def\vareiaiarchaion{𝀡}
  \def\apodermaarchaion{𝀢}
  \def\apothema{𝀣}
  \def\klasma{𝀤}
  \def\revma{𝀥}
  \def\piasmaarchaion{𝀦}
  \def\tinagma{𝀧}
  \def\anatrichisma{𝀨}
  \def\seisma{𝀩}
  \def\synagmaarchaion{𝀪}
  \def\synagmametastavrou{𝀫}
  \def\oyranismaarchaion{𝀬}
  \def\thema{𝀭}
  \def\lemoi{𝀮}
  \def\dyo{𝀯}
  \def\tria{𝀰}
  \def\tessera{𝀱}
  \def\kratimata{𝀲}
  \def\apesoexoneo{𝀳}
  \def\fthoraarchaion{𝀴}
  \def\imifthora{𝀵}
  \def\tromikonarchaion{𝀶}
  \def\katavatromikon{𝀷}
  \def\pelaston{𝀸}
  \def\psifistonar{𝀹}
  \def\kontevma{𝀺}
  \def\chorevmaarchaion{𝀻}
  \def\rapisma{𝀼}
  \def\parakalesmaarchaion{𝀽}
  \def\paraklitikiarchaion{𝀾}
  \def\ichadin{𝀿}
  \def\nana{𝁀}
  \def\petasma{𝁁}
  \def\kontevmaallo{𝁂}
  \def\tromikonallo{𝁃}
  \def\straggismata{𝁄}
  \def\gronthismata{𝁅}
  \def\is{𝁆}
  \def\olig{𝁇}
  \def\oksia{𝁈}
  \def\pet{𝁉}
  \def\koufisma{𝁊}
  \def\petastokoufisma{𝁋}
  \def\kratimokoufisma{𝁌}
  \def\pelastonneo{𝁍}
  \def\ypsiliaristera{𝁎}
  \def\ypsilimeso{𝁏}
  \def\ypsili{𝁐}
  \def\apo{𝁑}
  \def\apostrofoisyndesmosneo{𝁒}
  \def\yp{𝁓}
  \def\kratimoyporroon{𝁔}
  \def\el{𝁕}
  \def\xa{𝁖}
  \def\mikronis{𝁗}
  \def\var{𝁘}
  \def\piasmaneo{𝁙}
  \def\psifiston{𝁚}
  \def\omalon{𝁛}
  \def\antikenoma{𝁜}
  \def\lygisma{𝁝}
  \def\paraklitikineo{𝁞}
  \def\parakalesmaneo{𝁟}
  \def\eteron{𝁠}
  \def\kylisma{𝁡}
  \def\antikenokylisma{𝁢}
  \def\tromikonneo{𝁣}
  \def\ekstrepton{𝁤}
  \def\synagmaneo{𝁥}
  \def\syrma{𝁦}
  \def\chorevmaneo{𝁧}
  \def\epegerma{𝁨}
  \def\seismaneo{𝁩}
  \def\xironklasma{𝁪}
  \def\tromikopsifiston{𝁫}
  \def\psifistolygisma{𝁬}
  \def\tromikolygisma{𝁭}
  \def\tromikoparakalesma{𝁮}
  \def\psifistoparakalesma{𝁯}
  \def\tromikosynagma{𝁰}
  \def\psifistosynagma{𝁱}
  \def\gorgosyntheton{𝁲}
  \def\argosyntheton{𝁳}
  \def\eteronargosyntheton{𝁴}
  \def\oyranismaneo{𝁵}
  \def\thematismaseso{𝁶}
  \def\thematismosexo{𝁷}
  \def\themaaploun{𝁸}
  \def\theskaiapothes{𝁹}
  \def\katavasma{𝁺}
  \def\endofonon{𝁻}
  \def\yfenkato{𝁼}
  \def\yfenano{𝁽}
  \def\stavros{𝁾}
  \def\klasmaano{𝁿}
  \def\dipliar{𝂀}
  \def\kratimaarchaion{𝂁}
  \def\kratimaallo{𝂂}
  \def\kratimaneo{𝂃}
  \def\apodermaneo{𝂄}
  \def\apli{𝂅}
  \def\dipli{𝂆}
  \def\tripli{𝂇}
  \def\tetrapli{𝂈}
  \def\koronisbyz{𝂉}
  \def\leimmaenoschronou{𝂊}
  \def\leimmadyochronon{𝂋}
  \def\leimmatrionchronon{𝂌}
  \def\leimmatessaronchronon{𝂍}
  \def\leimmaimiseoschronou{𝂎}
  \def\gorgon{{\nruh 𝂏}}
  \def\gorgonparestigmenonaristera{{\nruh𝂐}}
  \def\gorgonparestigmenondexia{{\nruh𝂑}}
  \def\digorgon{{\nruh 𝂒}}
  \def\digorgparestigmaristerkato{{\nruh𝂓}}
  \def\digorgparestigmaristerano{{\nruh𝂔}}
  \def\digorgonparestigmenondexia{{\nruh𝂕}}
  \def\trigorgon{{\nruh 𝂖}}
  \def\argon{{\nruh𝂗}}
  \def\imidiargon{{\nruh𝂘}}
  \def\diargon{{\nruh𝂙}}
  \def\agogipoliargi{{\nruh𝂚}}
  \def\agogiargoteri{{\nruh𝂛}}
  \def\agogiargi{{\nruh𝂜}}
  \def\agogimetria{{\nruh𝂝}}
  \def\anooksia{{\nruh𝂞}}
  \def\agogigorgi{{\nruh𝂟}}
  \def\agogigorgoteri{{\nruh𝂠}}
  \def\agogipoligorgi{{\nruh𝂡}}
  \def\mpa{{\nruh 𝂢}}
  \def\mp{{\nruh 𝂣}}
  \def\mda{{\nruh 𝂤}}
  \def\mdb{{\nruh 𝂥}}
  \def\mt{{\nruh 𝂦}}
  \def\mtri{{\nruh 𝂧}}
  \def\mtet{{\nruh 𝂨}}
  \def\mleg{{\nruh 𝂩}}
  \def\mlegetos{{\nruh 𝂪}}
  \def\mpl{{\nruh 𝂫}}
  \def\istelichi{{\nruh 𝂬}}
  \def\mapos{{\nruh 𝂭}}
  \def\fantetra{{\nruh 𝂮}}
  \def\fanmono{{\nruh 𝂯\hspace{0.2em}}}
  \def\fandifon{{\nruh 𝂰}}
  \def\mvar{{\nruh 𝂱}}
  \def\mprotovarys{{\nruh 𝂲}}
  \def\mpltet{{\nruh 𝂳}}
  \def\moda{𝂴}
  \def\modb{𝂵}
  \def\fb{{\nruh 𝂶}}
  \def\imifonon{{\nruh 𝂷}}
  \def\imifthoron{{\nruh 𝂸}}
  \def\fda{{\nruh 𝂹}}
  \def\fp{{\nruh 𝂺}}
  \def\fg{{\nruh 𝂻}}
  \def\naos{{\nruh 𝂼}}
  \def\fd{{\nruh 𝂽}}
  \def\ms{{\nruh 𝂾}}
  \def\fk{{\nruh 𝂿}}
  \def\fz{{\nruh 𝃀}}
  \def\fn{{\nruh 𝃁}}
  \def\fna{{\nruh 𝃂}}
  \def\fm{{\nruh 𝃃}}
  \def\mm{{\nruh 𝃄}}
  \def\fs{{\nruh 𝃅}}
  \def\fmk{{\nruh 𝃆}}
  \def\fnenano{{\nruh 𝃇}}
  \def\chrzygos{{\nruh 𝃈}}
  \def\chrkliton{{\nruh 𝃉}}
  \def\chrspathi{{\nruh 𝃊}}
  \def\fen{{\nruh 𝃋}}
  \def\fenantifonia{{\nruh 𝃌}}
  \def\omalonapo{𝃍}
  \def\omalonol{𝃎}
  \def\omalonkn{𝃏}
  \def\d{{\nruh 𝃐}}
  \def\dd{{\nruh 𝃑}}
  \def\ddd{{\nruh 𝃒}}
  \def\dddd{{\nruh 𝃓}}
  \def\y{{\nruh 𝃔}}
  \def\yy{{\nruh 𝃕}}
  \def\yyy{{\nruh 𝃖}}
  \def\yyyy{{\nruh 𝃗}}
  \def\genikidiesis{{\nruh 𝃘}}
  \def\genikiyfesis{{\nruh 𝃙}}
  \def\diastolimikri{{\nruh 𝃚}}
  \def\diastoli{{\nruh 𝃛}}
  \def\diastolidipli{{\nruh 𝃜}}
  \def\diastolitheseos{{\nruh 𝃝}}
  \def\ism{{\nruh𝃞}}
  \def\isd{{\nruh𝃟}}
  \def\isk{{\nruh𝃠}}
  \def\isz{{\nruh𝃡}}
  \def\isn{{\nruh𝃢}}
  \def\isp{{\nruh𝃣}}
  \def\isB{{\nruh𝃤}}
  \def\isG{{\nruh𝃥}}
  \def\isD{{\nruh𝃦}}
  \def\isK{{\nruh𝃧}}
  \def\isZ{{\nruh𝃨}}
  \def\apa{{\nruh 𝃩}}
  \def\avu{{\nruh 𝃪}}
  \def\aga{{\nruh 𝃫}}
  \def\adi{{\nruh 𝃬}}
  \def\ake{{\nruh 𝃭}}
  \def\azo{{\nruh 𝃮}}
  \def\ani{{\nruh 𝃯}}
  \def\knta{𝃰}
  \def\kn{𝃱}
  \def\kntakato{𝃲}
  \def\knkato{𝃳}
  \def\klasmakato{𝃴}
  \def\gorgonkato{𝃵}
  \def\zwj{‍}
  \def\wj{⁠}
  \def\zwsp{​}
}{}
\newenvironment{troparion}{}{}
\newenvironment{neume}{
  \fontsize{\NeumeFontSize}{\NeumeFontSize}\NeumeFont
  \byzmacros
}{}

%% Lua-side code
\begin{luacode}
function sometexttocommand ( line )
    line = string.gsub ( line , "𝂏", "\\gorgon" )
    line = string.gsub ( line , "𝂐", "\\gorgonparestigmenonaristera" )
    line = string.gsub ( line , "𝂑", "\\gorgonparestigmenondexia" )
    line = string.gsub ( line , "𝂒", "\\digorgon" )
    line = string.gsub ( line , "𝂓", "\\digorgparestigmaristerkato" )
    line = string.gsub ( line , "𝂔", "\\digorgparestigmaristerano" )
    line = string.gsub ( line , "𝂕", "\\digorgonparestigmenondexia" )
    line = string.gsub ( line , "𝂖", "\\trigorgon" )
    line = string.gsub ( line , "𝂗", "\\argon" )
    line = string.gsub ( line , "𝂘", "\\imidiargon" )
    line = string.gsub ( line , "𝂙", "\\diargon" )
    line = string.gsub ( line , "𝂚", "\\agogipoliargi" )
    line = string.gsub ( line , "𝂛", "\\agogiargoteri" )
    line = string.gsub ( line , "𝂜", "\\agogiargi" )
    line = string.gsub ( line , "𝂝", "\\agogimetria" )
    line = string.gsub ( line , "𝂞", "\\anooksia" )
    line = string.gsub ( line , "𝂟", "\\agogigorgi" )
    line = string.gsub ( line , "𝂠", "\\agogigorgoteri" )
    line = string.gsub ( line , "𝂡", "\\agogipoligorgi" )
    line = string.gsub ( line , "𝂢", "\\mpa" )
    line = string.gsub ( line , "𝂣", "\\mp" )
    line = string.gsub ( line , "𝂤", "\\mda" )
    line = string.gsub ( line , "𝂥", "\\mdb" )
    line = string.gsub ( line , "𝂦", "\\mt" )
    line = string.gsub ( line , "𝂧", "\\mtri" )
    line = string.gsub ( line , "𝂨", "\\mtet" )
    line = string.gsub ( line , "𝂩", "\\mleg" )
    line = string.gsub ( line , "𝂪", "\\mlegetos" )
    line = string.gsub ( line , "𝂫", "\\mpl" )
    line = string.gsub ( line , "𝂬", "\\istelichi" )
    line = string.gsub ( line , "𝂭", "\\mapos" )
    line = string.gsub ( line , "𝂮", "\\fantetra" )
    line = string.gsub ( line , "𝂯", "\\fanmono" )
    line = string.gsub ( line , "𝂰", "\\fandifon" )
    line = string.gsub ( line , "𝂱", "\\mvar" )
    line = string.gsub ( line , "𝂲", "\\mprotovarys" )
    line = string.gsub ( line , "𝂳", "\\mpltet" )
    line = string.gsub ( line , "𝂶", "\\fb" )
    line = string.gsub ( line , "𝂷", "\\imifonon" )
    line = string.gsub ( line , "𝂸", "\\imifthoron" )
    line = string.gsub ( line , "𝂹", "\\fda" )
    line = string.gsub ( line , "𝂺", "\\fp" )
    line = string.gsub ( line , "𝂻", "\\fg" )
    line = string.gsub ( line , "𝂼", "\\naos" )
    line = string.gsub ( line , "𝂽", "\\fd" )
    line = string.gsub ( line , "𝂾", "\\ms" )
    line = string.gsub ( line , "𝂿", "\\fk" )
    line = string.gsub ( line , "𝃀", "\\fz" )
    line = string.gsub ( line , "𝃁", "\\fn" )
    line = string.gsub ( line , "𝃂", "\\fna" )
    line = string.gsub ( line , "𝃃", "\\fm" )
    line = string.gsub ( line , "𝃄", "\\mm" )
    line = string.gsub ( line , "𝃅", "\\fs" )
    line = string.gsub ( line , "𝃆", "\\fmk" )
    line = string.gsub ( line , "𝃇", "\\fnenano" )
    line = string.gsub ( line , "𝃈", "\\chrzygos" )
    line = string.gsub ( line , "𝃉", "\\chrkliton" )
    line = string.gsub ( line , "𝃊", "\\chrspathi" )
    line = string.gsub ( line , "𝃋", "\\fen" )
    line = string.gsub ( line , "𝃌", "\\fenantifonia" )
    line = string.gsub ( line , "𝃐", "\\d" )
    line = string.gsub ( line , "𝃑", "\\dd" )
    line = string.gsub ( line , "𝃒", "\\ddd" )
    line = string.gsub ( line , "𝃓", "\\dddd" )
    line = string.gsub ( line , "𝃔", "\\y" )
    line = string.gsub ( line , "𝃕", "\\yy" )
    line = string.gsub ( line , "𝃖", "\\yyy" )
    line = string.gsub ( line , "𝃗", "\\yyyy" )
    line = string.gsub ( line , "𝃘", "\\genikidiesis" )
    line = string.gsub ( line , "𝃙", "\\genikiyfesis" )
    line = string.gsub ( line , "𝃚", "\\diastolimikri" )
    line = string.gsub ( line , "𝃛", "\\diastoli" )
    line = string.gsub ( line , "𝃜", "\\diastolidipli" )
    line = string.gsub ( line , "𝃝", "\\diastolitheseos" )
    line = string.gsub ( line , "𝃞", "\\ism" )
    line = string.gsub ( line , "𝃟", "\\isd" )
    line = string.gsub ( line , "𝃠", "\\isk" )
    line = string.gsub ( line , "𝃡", "\\isz" )
    line = string.gsub ( line , "𝃢", "\\isn" )
    line = string.gsub ( line , "𝃣", "\\isp" )
    line = string.gsub ( line , "𝃤", "\\isB" )
    line = string.gsub ( line , "𝃥", "\\isG" )
    line = string.gsub ( line , "𝃦", "\\isD" )
    line = string.gsub ( line , "𝃧", "\\isK" )
    line = string.gsub ( line , "𝃨", "\\isZ" )
    line = string.gsub ( line , "𝃩", "\\apa" )
    line = string.gsub ( line , "𝃪", "\\avu" )
    line = string.gsub ( line , "𝃫", "\\aga" )
    line = string.gsub ( line , "𝃬", "\\adi" )
    line = string.gsub ( line , "𝃭", "\\ake" )
    line = string.gsub ( line , "𝃮", "\\azo" )
    line = string.gsub ( line , "𝃯", "\\ani" )
    return ( line )
end
\end{luacode}

%% TeX-side code
\newenvironment{NeumeParseUnicode}{%
   \directlua{luatexbase.add_to_callback(
              "process_input_buffer",
              sometexttocommand, "sometexttocommand")}}{%
   \directlua{luatexbase.remove_from_callback(
              "process_input_buffer",
              "sometexttocommand")}}
