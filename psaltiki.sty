% Ãelou! KÃ¡evarju dÃºing?  This is my first package ever and if it is
% beneficial to you, then I am very happy, my frjÃ©nding.
%
% (c) AnastÃ¡zius KaejatÃ­ DariÃ¡n
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{psaltiki}
\RequirePackage{fontspec,setspace,stackengine,varwidth,luacode,luatexbase}

\@ifpackageloaded{xcolor}{\providecommand\ruh{\color{red}}}{}
\@ifpackageloaded{luacolor}{\providecommand\nruh{\color{red}}\providecommand\ruh{\nruh}}{}
\providecommand\ruh{}\providecommand\nruh{}

\providecommand\defaulthxostext{á¼¯Ï‡Î¿Ï‚}
\providecommand\hxosfonthook{\greekfont}
\providecommand\texthxos[4][\defaulthxostext]{{
  \unskip\ruh\nruh
  \unskip\let\NeumeFontScaleFactor\NeumeFontScaleFactorHxos\NeumeAutoResize
  {\hxosfonthook #1 }
  {\neume #2}
  {\hxosfonthook #3 }
  {\neume #4 }
}}
\providecommand\foretext[1]{{\centering\nruh\ruh #1\par\vspace{-\parskip}}}
\providecommand\hxos[4][\defaulthxostext]{\foretext{\texthxos[#1]{#2}{#3}{#4}}}
\providecommand\smallhxos[4][\defaulthxostext]{{
  \setlength\parskip{0.5\parskip}
  \setstretch{0.6}
  \hxos[#1]{#2}{#3}{#4}
}}
\newlength\NeumeAlignment
\newlength\NeumePadding
\newlength\NeumeTextPadding
\newlength\NeumeComboPadding

\providecommand\NeumeFontScaleFactor{5}
\providecommand\NeumeFontScaleFactorHxos{2.6}
\providecommand\NeumeFontScaleFactorInline{2.4}
\providecommand\NeumeAlignmentScaleFactor{-0.2}
\providecommand\NeumePaddingScaleFactor{0}
\providecommand\NeumeTextPaddingScaleFactor{0}
\providecommand\NeumeComboPaddingScaleFactor{0}
\providecommand\DropcapScaleFactor{6}
\providecommand\NeumeAutoResize{
  \unskip\setlength\tmpFontSize{\f@size pt}
  \unskip\setlength\NeumeFontSize    {\NeumeFontScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeAlignment   {\NeumeAlignmentScaleFactor\tmpFontSize}
  \unskip\setlength\NeumePadding     {\NeumePaddingScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeTextPadding {\NeumeTextPaddingScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeComboPadding{\NeumeComboPaddingScaleFactor\tmpFontSize}
  \unskip\ignorespaces
}
\def\storefirstletter #1#2 {
  \ifcat\noexpand\relax\noexpand#1\def\next{#1{#2}\storefirstletter}\else
  \def\next{\def\firstletter{#1}\def\firstletterremainder{#2}}\fi
  \next
}
\providecommand\dropfont{}
\providecommand\neumedropcommand[1]{{
  \unskip\NeumeAutoResize
  \unskip\dropfont\scshape\ruh\fontsize{\DropcapScaleFactor\tmpFontSize}
  {\DropcapScaleFactor\tmpFontSize}\selectfont\ignorespaces #1 \unskip\hspace{-\NeumeAlignment}\ignorespaces
}}
\providecommand\dropstack[2][\_]{{
  \unskip\storefirstletter #1
  \unskip\neumedropcommand{\firstletter}
  \unskip\neumestack[\scshape\firstletterremainder]{\ignorespaces #2 \unskip}\ignorespaces
}}
\newfontface\NeumeFont{SERAFIM+}
\newlength\tmpFontSize
\newlength\NeumeFontSize
\newlength\tmpStackFontSize
\NeumeAutoResize
\providecommand\neumestack[2][\_]{
  \unskip\renewcommand\stackalignment{c}
  \unskip\renewcommand\stacktype{L}
  \unskip\stackon{\strut\hspace{0.5\NeumeTextPadding}
  \unskip\ignorespaces #1 \unskip\hspace{0.5\NeumeTextPadding}}{
    \unskip{\neume\strut\hspace{\NeumeAlignment}\hspace{0.5\NeumePadding}
    \unskip\ignorespaces #2 \unskip\hspace{-\NeumeAlignment}\hspace{0.5\NeumePadding}}\ignorespaces
  }\hspace{\NeumeComboPadding}{\fontsize{0.5\tmpFontSize}{0.5\tmpFontSize}\selectfont{ }}\ignorespaces
}
\providecommand\annotate[2]{
  \unskip\renewcommand\stacktype{S}
  \unskip\renewcommand\stackalignment{l}
  \unskip\setlength\tmpStackFontSize{\f@size pt}
  \unskip\stackon{\ignorespaces #1 \unskip}{
    \unskip\fontsize{0.5\tmpStackFontSize}{0.5\tmpStackFontSize}\selectfont
    \unskip\begin{varwidth}[t][5ex][t]{\textwidth}
      \unskip\ \\*[-2ex]
      \unskip\ruh{\ignorespaces #2 \unskip}
    \unskip\end{varwidth}\ignorespaces
  }\ignorespaces
}
\newenvironment{byzmacros}{
  \unskip\def\daseia{ğ€}
  \unskip\def\perispomeni{ğ€‚}
  \unskip\def\oxeiaekfonitikon{ğ€ƒ}
  \unskip\def\oxeiadipli{ğ€„}
  \unskip\def\vareiaekfonitikon{ğ€…}
  \unskip\def\vareiadipli{ğ€†}
  \unskip\def\kathisti{ğ€‡}
  \unskip\def\syrmatiki{ğ€ˆ}
  \unskip\def\paraklitiki{ğ€‰}
  \unskip\def\ypokrisis{ğ€Š}
  \unskip\def\ypokrisisdipli{ğ€‹}
  \unskip\def\kremasti{ğ€Œ}
  \unskip\def\apesoekfonitikon{ğ€}
  \unskip\def\exoekfonitikon{ğ€}
  \unskip\def\teleia{ğ€}
  \unskip\def\kntaek{ğ€}
  \unskip\def\apostrofos{ğ€‘}
  \unskip\def\apostrofosdipli{ğ€’}
  \unskip\def\synevma{ğ€“}
  \unskip\def\thita{ğ€”}
  \unskip\def\oligarchaion{ğ€•}
  \unskip\def\gorgonarchaion{ğ€–}
  \unskip\def\psilon{ğ€—}
  \unskip\def\chamilon{ğ€˜}
  \unskip\def\vathy{ğ€™}
  \unskip\def\isarchaion{ğ€š}
  \unskip\def\knarchaion{ğ€›}
  \unskip\def\kntaekarchaion{ğ€œ}
  \unskip\def\saximata{ğ€}
  \unskip\def\parichon{ğ€}
  \unskip\def\stavrosapodexia{ğ€Ÿ}
  \unskip\def\oxeiaarchaion{ğ€ }
  \unskip\def\vareiaiarchaion{ğ€¡}
  \unskip\def\apodermaarchaion{ğ€¢}
  \unskip\def\apothema{ğ€£}
  \unskip\def\klasma{ğ€¤}
  \unskip\def\revma{ğ€¥}
  \unskip\def\piasmaarchaion{ğ€¦}
  \unskip\def\tinagma{ğ€§}
  \unskip\def\anatrichisma{ğ€¨}
  \unskip\def\seisma{ğ€©}
  \unskip\def\synagmaarchaion{ğ€ª}
  \unskip\def\synagmametastavrou{ğ€«}
  \unskip\def\oyranismaarchaion{ğ€¬}
  \unskip\def\thema{ğ€­}
  \unskip\def\lemoi{ğ€®}
  \unskip\def\dyo{ğ€¯}
  \unskip\def\tria{ğ€°}
  \unskip\def\tessera{ğ€±}
  \unskip\def\kratimata{ğ€²}
  \unskip\def\apesoexoneo{ğ€³}
  \unskip\def\fthoraarchaion{ğ€´}
  \unskip\def\imifthora{ğ€µ}
  \unskip\def\tromikonarchaion{ğ€¶}
  \unskip\def\katavatromikon{ğ€·}
  \unskip\def\pelaston{ğ€¸}
  \unskip\def\psifistonar{ğ€¹}
  \unskip\def\kontevma{ğ€º}
  \unskip\def\chorevmaarchaion{ğ€»}
  \unskip\def\rapisma{ğ€¼}
  \unskip\def\parakalesmaarchaion{ğ€½}
  \unskip\def\paraklitikiarchaion{ğ€¾}
  \unskip\def\ichadin{ğ€¿}
  \unskip\def\nana{ğ€}
  \unskip\def\petasma{ğ}
  \unskip\def\kontevmaallo{ğ‚}
  \unskip\def\tromikonallo{ğƒ}
  \unskip\def\straggismata{ğ„}
  \unskip\def\gronthismata{ğ…}
  \unskip\def\is{ğ†}
  \unskip\def\olig{ğ‡}
  \unskip\def\oksia{ğˆ}
  \unskip\def\pet{ğ‰}
  \unskip\def\koufisma{ğŠ}
  \unskip\def\petastokoufisma{ğ‹}
  \unskip\def\kratimokoufisma{ğŒ}
  \unskip\def\pelastonneo{ğ}
  \unskip\def\ypsiliaristera{ğ}
  \unskip\def\ypsilimeso{ğ}
  \unskip\def\ypsili{ğ}
  \unskip\def\apo{ğ‘}
  \unskip\def\apostrofoisyndesmosneo{ğ’}
  \unskip\def\yp{ğ“}
  \unskip\def\kratimoyporroon{ğ”}
  \unskip\def\el{ğ•}
  \unskip\def\xa{ğ–}
  \unskip\def\mikronis{ğ—}
  \unskip\def\var{ğ˜}
  \unskip\def\piasmaneo{ğ™}
  \unskip\def\psifiston{ğš}
  \unskip\def\omalon{ğ›}
  \unskip\def\antikenoma{ğœ}
  \unskip\def\lygisma{ğ}
  \unskip\def\paraklitikineo{ğ}
  \unskip\def\parakalesmaneo{ğŸ}
  \unskip\def\eteron{ğ }
  \unskip\def\kylisma{ğ¡}
  \unskip\def\antikenokylisma{ğ¢}
  \unskip\def\tromikonneo{ğ£}
  \unskip\def\ekstrepton{ğ¤}
  \unskip\def\synagmaneo{ğ¥}
  \unskip\def\syrma{ğ¦}
  \unskip\def\chorevmaneo{ğ§}
  \unskip\def\epegerma{ğ¨}
  \unskip\def\seismaneo{ğ©}
  \unskip\def\xironklasma{ğª}
  \unskip\def\tromikopsifiston{ğ«}
  \unskip\def\psifistolygisma{ğ¬}
  \unskip\def\tromikolygisma{ğ­}
  \unskip\def\tromikoparakalesma{ğ®}
  \unskip\def\psifistoparakalesma{ğ¯}
  \unskip\def\tromikosynagma{ğ°}
  \unskip\def\psifistosynagma{ğ±}
  \unskip\def\gorgosyntheton{ğ²}
  \unskip\def\argosyntheton{ğ³}
  \unskip\def\eteronargosyntheton{ğ´}
  \unskip\def\oyranismaneo{ğµ}
  \unskip\def\thematismaseso{ğ¶}
  \unskip\def\thematismosexo{ğ·}
  \unskip\def\themaaploun{ğ¸}
  \unskip\def\theskaiapothes{ğ¹}
  \unskip\def\katavasma{ğº}
  \unskip\def\endofonon{ğ»}
  \unskip\def\yfenkato{ğ¼}
  \unskip\def\yfenano{ğ½}
  \unskip\def\stavros{ğ¾}
  \unskip\def\klasmaano{ğ¿}
  \unskip\def\dipliar{ğ‚€}
  \unskip\def\kratimaarchaion{ğ‚}
  \unskip\def\kratimaallo{ğ‚‚}
  \unskip\def\kratimaneo{ğ‚ƒ}
  \unskip\def\apodermaneo{ğ‚„}
  \unskip\def\apli{ğ‚…}
  \unskip\def\dipli{ğ‚†}
  \unskip\def\tripli{ğ‚‡}
  \unskip\def\tetrapli{ğ‚ˆ}
  \unskip\def\koronisbyz{ğ‚‰}
  \unskip\def\leimmaenoschronou{ğ‚Š}
  \unskip\def\leimmadyochronon{ğ‚‹}
  \unskip\def\leimmatrionchronon{ğ‚Œ}
  \unskip\def\leimmatessaronchronon{ğ‚}
  \unskip\def\leimmaimiseoschronou{ğ‚}
  \unskip\def\gorgon{{\nruh ğ‚}}
  \unskip\def\gorgonparestigmenonaristera{{\nruhğ‚}}
  \unskip\def\gorgonparestigmenondexia{{\nruhğ‚‘}}
  \unskip\def\digorgon{{\nruh ğ‚’}}
  \unskip\def\digorgparestigmaristerkato{{\nruhğ‚“}}
  \unskip\def\digorgparestigmaristerano{{\nruhğ‚”}}
  \unskip\def\digorgonparestigmenondexia{{\nruhğ‚•}}
  \unskip\def\trigorgon{{\nruh ğ‚–}}
  \unskip\def\argon{{\nruhğ‚—}}
  \unskip\def\imidiargon{{\nruhğ‚˜}}
  \unskip\def\diargon{{\nruhğ‚™}}
  \unskip\def\agogipoliargi{{\nruhğ‚š}}
  \unskip\def\agogiargoteri{{\nruhğ‚›}}
  \unskip\def\agogiargi{{\nruhğ‚œ}}
  \unskip\def\agogimetria{{\nruhğ‚}}
  \unskip\def\anooksia{{\nruhğ‚}}
  \unskip\def\agogigorgi{{\nruhğ‚Ÿ}}
  \unskip\def\agogigorgoteri{{\nruhğ‚ }}
  \unskip\def\agogipoligorgi{{\nruhğ‚¡}}
  \unskip\def\mpa{{\nruh ğ‚¢}}
  \unskip\def\mp{{\nruh ğ‚£}}
  \unskip\def\mda{{\nruh ğ‚¤}}
  \unskip\def\mdb{{\nruh ğ‚¥}}
  \unskip\def\mt{{\nruh ğ‚¦}}
  \unskip\def\mtri{{\nruh ğ‚§}}
  \unskip\def\mtet{{\nruh ğ‚¨}}
  \unskip\def\mleg{{\nruh ğ‚©}}
  \unskip\def\mlegetos{{\nruh ğ‚ª}}
  \unskip\def\mpl{{\nruh ğ‚«}}
  \unskip\def\istelichi{{\nruh ğ‚¬}}
  \unskip\def\mapos{{\nruh ğ‚­}}
  \unskip\def\fantetra{{\nruh ğ‚®}}
  \unskip\def\fanmono{{\nruh ğ‚¯}}
  \unskip\def\fandifon{{\nruh ğ‚°}}
  \unskip\def\mvar{{\nruh ğ‚±}}
  \unskip\def\mprotovarys{{\nruh ğ‚²}}
  \unskip\def\mpltet{{\nruh ğ‚³}}
  \unskip\def\moda{ğ‚´}
  \unskip\def\modb{ğ‚µ}
  \unskip\def\fb{{\nruh ğ‚¶}}
  \unskip\def\imifonon{{\nruh ğ‚·}}
  \unskip\def\imifthoron{{\nruh ğ‚¸}}
  \unskip\def\fda{{\nruh ğ‚¹}}
  \unskip\def\fp{{\nruh ğ‚º}}
  \unskip\def\fg{{\nruh ğ‚»}}
  \unskip\def\naos{{\nruh ğ‚¼}}
  \unskip\def\fd{{\nruh ğ‚½}}
  \unskip\def\ms{{\nruh ğ‚¾}}
  \unskip\def\fk{{\nruh ğ‚¿}}
  \unskip\def\fz{{\nruh ğƒ€}}
  \unskip\def\fn{{\nruh ğƒ}}
  \unskip\def\fna{{\nruh ğƒ‚}}
  \unskip\def\fm{{\nruh ğƒƒ}}
  \unskip\def\mm{{\nruh ğƒ„}}
  \unskip\def\fs{{\nruh ğƒ…}}
  \unskip\def\fmk{{\nruh ğƒ†}}
  \unskip\def\fnenano{{\nruh ğƒ‡}}
  \unskip\def\chrzygos{{\nruh ğƒˆ}}
  \unskip\def\chrkliton{{\nruh ğƒ‰}}
  \unskip\def\chrspathi{{\nruh ğƒŠ}}
  \unskip\def\fen{{\nruh ğƒ‹}}
  \unskip\def\fenantifonia{{\nruh ğƒŒ}}
  \unskip\def\omalonapo{ğƒ}
  \unskip\def\omalonol{ğƒ}
  \unskip\def\omalonkn{ğƒ}
  \unskip\def\d{{\nruh ğƒ}}
  \unskip\def\dd{{\nruh ğƒ‘}}
  \unskip\def\ddd{{\nruh ğƒ’}}
  \unskip\def\dddd{{\nruh ğƒ“}}
  \unskip\def\y{{\nruh ğƒ”}}
  \unskip\def\yy{{\nruh ğƒ•}}
  \unskip\def\yyy{{\nruh ğƒ–}}
  \unskip\def\yyyy{{\nruh ğƒ—}}
  \unskip\def\genikidiesis{{\nruh ğƒ˜}}
  \unskip\def\genikiyfesis{{\nruh ğƒ™}}
  \unskip\def\diastolimikri{{\nruh ğƒš}}
  \unskip\def\diastoli{{\nruh ğƒ›}}
  \unskip\def\diastolidipli{{\nruh ğƒœ}}
  \unskip\def\diastolitheseos{{\nruh ğƒ}}
  \unskip\def\ism{{\nruhğƒ}}
  \unskip\def\isd{{\nruhğƒŸ}}
  \unskip\def\isk{{\nruhğƒ }}
  \unskip\def\isz{{\nruhğƒ¡}}
  \unskip\def\isn{{\nruhğƒ¢}}
  \unskip\def\isp{{\nruhğƒ£}}
  \unskip\def\isB{{\nruhğƒ¤}}
  \unskip\def\isG{{\nruhğƒ¥}}
  \unskip\def\isD{{\nruhğƒ¦}}
  \unskip\def\isK{{\nruhğƒ§}}
  \unskip\def\isZ{{\nruhğƒ¨}}
  \unskip\def\apa{{\nruh ğƒ©}}
  \unskip\def\avu{{\nruh ğƒª}}
  \unskip\def\aga{{\nruh ğƒ«}}
  \unskip\def\adi{{\nruh ğƒ¬}}
  \unskip\def\ake{{\nruh ğƒ­}}
  \unskip\def\azo{{\nruh ğƒ®}}
  \unskip\def\ani{{\nruh ğƒ¯}}
  \unskip\def\knta{ğƒ°}
  \unskip\def\kn{ğƒ±}
  \unskip\def\kntakato{ğƒ²}
  \unskip\def\knkato{ğƒ³}
  \unskip\def\klasmakato{ğƒ´}
  \unskip\def\gorgonkato{ğƒµ}
  \unskip\def\zwj{â€}
  \unskip\def\wj{â }
  \unskip\def\zwsp{â€‹}
  \unskip\ignorespaces
}{}
\newenvironment{troparion}{}{}
\newenvironment{neume}{
  \unskip\fontsize{\NeumeFontSize}{\NeumeFontSize}\NeumeFont
  \unskip\byzmacros\ignorespaces
}{\unskip\ignorespaces}

%% Lua-side code
\begin{luacode}
function sometexttocommand ( line )
    line = string.gsub ( line , "ğ‚", "\\gorgon" )
    line = string.gsub ( line , "ğ‚", "\\gorgonparestigmenonaristera" )
    line = string.gsub ( line , "ğ‚‘", "\\gorgonparestigmenondexia" )
    line = string.gsub ( line , "ğ‚’", "\\digorgon" )
    line = string.gsub ( line , "ğ‚“", "\\digorgparestigmaristerkato" )
    line = string.gsub ( line , "ğ‚”", "\\digorgparestigmaristerano" )
    line = string.gsub ( line , "ğ‚•", "\\digorgonparestigmenondexia" )
    line = string.gsub ( line , "ğ‚–", "\\trigorgon" )
    line = string.gsub ( line , "ğ‚—", "\\argon" )
    line = string.gsub ( line , "ğ‚˜", "\\imidiargon" )
    line = string.gsub ( line , "ğ‚™", "\\diargon" )
    line = string.gsub ( line , "ğ‚š", "\\agogipoliargi" )
    line = string.gsub ( line , "ğ‚›", "\\agogiargoteri" )
    line = string.gsub ( line , "ğ‚œ", "\\agogiargi" )
    line = string.gsub ( line , "ğ‚", "\\agogimetria" )
    line = string.gsub ( line , "ğ‚", "\\anooksia" )
    line = string.gsub ( line , "ğ‚Ÿ", "\\agogigorgi" )
    line = string.gsub ( line , "ğ‚ ", "\\agogigorgoteri" )
    line = string.gsub ( line , "ğ‚¡", "\\agogipoligorgi" )
    line = string.gsub ( line , "ğ‚¢", "\\mpa" )
    line = string.gsub ( line , "ğ‚£", "\\mp" )
    line = string.gsub ( line , "ğ‚¤", "\\mda" )
    line = string.gsub ( line , "ğ‚¥", "\\mdb" )
    line = string.gsub ( line , "ğ‚¦", "\\mt" )
    line = string.gsub ( line , "ğ‚§", "\\mtri" )
    line = string.gsub ( line , "ğ‚¨", "\\mtet" )
    line = string.gsub ( line , "ğ‚©", "\\mleg" )
    line = string.gsub ( line , "ğ‚ª", "\\mlegetos" )
    line = string.gsub ( line , "ğ‚«", "\\mpl" )
    line = string.gsub ( line , "ğ‚¬", "\\istelichi" )
    line = string.gsub ( line , "ğ‚­", "\\mapos" )
    line = string.gsub ( line , "ğ‚®", "\\fantetra" )
    line = string.gsub ( line , "ğ‚¯", "\\fanmono" )
    line = string.gsub ( line , "ğ‚°", "\\fandifon" )
    line = string.gsub ( line , "ğ‚±", "\\mvar" )
    line = string.gsub ( line , "ğ‚²", "\\mprotovarys" )
    line = string.gsub ( line , "ğ‚³", "\\mpltet" )
    line = string.gsub ( line , "ğ‚¶", "\\fb" )
    line = string.gsub ( line , "ğ‚·", "\\imifonon" )
    line = string.gsub ( line , "ğ‚¸", "\\imifthoron" )
    line = string.gsub ( line , "ğ‚¹", "\\fda" )
    line = string.gsub ( line , "ğ‚º", "\\fp" )
    line = string.gsub ( line , "ğ‚»", "\\fg" )
    line = string.gsub ( line , "ğ‚¼", "\\naos" )
    line = string.gsub ( line , "ğ‚½", "\\fd" )
    line = string.gsub ( line , "ğ‚¾", "\\ms" )
    line = string.gsub ( line , "ğ‚¿", "\\fk" )
    line = string.gsub ( line , "ğƒ€", "\\fz" )
    line = string.gsub ( line , "ğƒ", "\\fn" )
    line = string.gsub ( line , "ğƒ‚", "\\fna" )
    line = string.gsub ( line , "ğƒƒ", "\\fm" )
    line = string.gsub ( line , "ğƒ„", "\\mm" )
    line = string.gsub ( line , "ğƒ…", "\\fs" )
    line = string.gsub ( line , "ğƒ†", "\\fmk" )
    line = string.gsub ( line , "ğƒ‡", "\\fnenano" )
    line = string.gsub ( line , "ğƒˆ", "\\chrzygos" )
    line = string.gsub ( line , "ğƒ‰", "\\chrkliton" )
    line = string.gsub ( line , "ğƒŠ", "\\chrspathi" )
    line = string.gsub ( line , "ğƒ‹", "\\fen" )
    line = string.gsub ( line , "ğƒŒ", "\\fenantifonia" )
    line = string.gsub ( line , "ğƒ", "\\d" )
    line = string.gsub ( line , "ğƒ‘", "\\dd" )
    line = string.gsub ( line , "ğƒ’", "\\ddd" )
    line = string.gsub ( line , "ğƒ“", "\\dddd" )
    line = string.gsub ( line , "ğƒ”", "\\y" )
    line = string.gsub ( line , "ğƒ•", "\\yy" )
    line = string.gsub ( line , "ğƒ–", "\\yyy" )
    line = string.gsub ( line , "ğƒ—", "\\yyyy" )
    line = string.gsub ( line , "ğƒ˜", "\\genikidiesis" )
    line = string.gsub ( line , "ğƒ™", "\\genikiyfesis" )
    line = string.gsub ( line , "ğƒš", "\\diastolimikri" )
    line = string.gsub ( line , "ğƒ›", "\\diastoli" )
    line = string.gsub ( line , "ğƒœ", "\\diastolidipli" )
    line = string.gsub ( line , "ğƒ", "\\diastolitheseos" )
    line = string.gsub ( line , "ğƒ", "\\ism" )
    line = string.gsub ( line , "ğƒŸ", "\\isd" )
    line = string.gsub ( line , "ğƒ ", "\\isk" )
    line = string.gsub ( line , "ğƒ¡", "\\isz" )
    line = string.gsub ( line , "ğƒ¢", "\\isn" )
    line = string.gsub ( line , "ğƒ£", "\\isp" )
    line = string.gsub ( line , "ğƒ¤", "\\isB" )
    line = string.gsub ( line , "ğƒ¥", "\\isG" )
    line = string.gsub ( line , "ğƒ¦", "\\isD" )
    line = string.gsub ( line , "ğƒ§", "\\isK" )
    line = string.gsub ( line , "ğƒ¨", "\\isZ" )
    line = string.gsub ( line , "ğƒ©", "\\apa" )
    line = string.gsub ( line , "ğƒª", "\\avu" )
    line = string.gsub ( line , "ğƒ«", "\\aga" )
    line = string.gsub ( line , "ğƒ¬", "\\adi" )
    line = string.gsub ( line , "ğƒ­", "\\ake" )
    line = string.gsub ( line , "ğƒ®", "\\azo" )
    line = string.gsub ( line , "ğƒ¯", "\\ani" )
    return ( line )
end
\end{luacode}

%% TeX-side code
\newenvironment{NeumeParseUnicode}{%
   \directlua{luatexbase.add_to_callback(
              "process_input_buffer",
              sometexttocommand, "sometexttocommand")}}{%
   \directlua{luatexbase.remove_from_callback(
              "process_input_buffer",
              "sometexttocommand")}}
