% Áelou! Káevarju dúing?  This is my first package ever and if it is
% beneficial to you, then I am very happy, my frjénding.
%
% (c) Anastázius Kaejatí Darián
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{psaltiki}
\RequirePackage{fontspec,stackengine,varwidth}

\@ifpackageloaded{xcolor}{\providecommand\ruh{\color{red}}}{}
\@ifpackageloaded{luacolor}{\providecommand\ruh{\color{red}}}{}
\providecommand\ruh{}

\newcommand\needspacecommandwrapper[1]{}
\@ifpackageloaded{needspace}{
  \renewcommand\needspacecommandwrapper[1]{\Needspace*{#1}}
}{}
\newcommand\hxos[4][Ἧχος]{
  \needspacecommandwrapper{6\baselineskip}
  {\centering\ruh
  \renewcommand\NeumeFontScaleFactor{2.5}\NeumeAutoResize
  #1
  {\neume #2}
  #3
  {\neume #4}
  \par
  }\nopagebreak
}
\newcommand\NeumeFontScaleFactor{5}
\newcommand\NeumeAutoResize{
  \setlength\tmpFontSize{\f@size pt}
  \setlength\NeumeFontSize{\NeumeFontScaleFactor\tmpFontSize}
}
\newfontface\NeumeFont{SERAFIM+}
\newlength\tmpFontSize
\newlength\NeumeFontSize
\NeumeAutoResize
\newlength\NeumeStackSpace\setlength\NeumeStackSpace{-0.65em}
\newcommand{\neumestack}[2][]{
  \renewcommand\stacktype{L}
  \stackon{\strut#1}{
    {\neume\strut#2}
  }\hspace{\NeumeStackSpace}
}
\newcommand{\annotate}[2]{
  \renewcommand\stacktype{S}
  \setlength\tmpFontSize{\f@size pt}
  \stackon{#2}{
    \fontsize{0.5\tmpFontSize}{0.5\tmpFontSize}\selectfont
    \begin{varwidth}[t][5ex][t]{\textwidth}
      \ \\*[-2ex]
      \ruh #1
    \end{varwidth}
  }
}
\newenvironment{byzmacros}{
  \def\daseia{𝀁}
  \def\perispomeni{𝀂}
  \def\oxeiaekfonitikon{𝀃}
  \def\oxeiadipli{𝀄}
  \def\vareiaekfonitikon{𝀅}
  \def\vareiadipli{𝀆}
  \def\kathisti{𝀇}
  \def\syrmatiki{𝀈}
  \def\paraklitiki{𝀉}
  \def\ypokrisis{𝀊}
  \def\ypokrisisdipli{𝀋}
  \def\kremasti{𝀌}
  \def\apesoekfonitikon{𝀍}
  \def\exoekfonitikon{𝀎}
  \def\teleia{𝀏}
  \def\kntaek{𝀐}
  \def\apostrofos{𝀑}
  \def\apostrofosdipli{𝀒}
  \def\synevma{𝀓}
  \def\thita{𝀔}
  \def\oligarchaion{𝀕}
  \def\gorgonarchaion{𝀖}
  \def\psilon{𝀗}
  \def\chamilon{𝀘}
  \def\vathy{𝀙}
  \def\isarchaion{𝀚}
  \def\knarchaion{𝀛}
  \def\kntaekarchaion{𝀜}
  \def\saximata{𝀝}
  \def\parichon{𝀞}
  \def\stavrosapodexia{𝀟}
  \def\oxeiaarchaion{𝀠}
  \def\vareiaiarchaion{𝀡}
  \def\apodermaarchaion{𝀢}
  \def\apothema{𝀣}
  \def\klasma{𝀤}
  \def\revma{𝀥}
  \def\piasmaarchaion{𝀦}
  \def\tinagma{𝀧}
  \def\anatrichisma{𝀨}
  \def\seisma{𝀩}
  \def\synagmaarchaion{𝀪}
  \def\synagmametastavrou{𝀫}
  \def\oyranismaarchaion{𝀬}
  \def\thema{𝀭}
  \def\lemoi{𝀮}
  \def\dyo{𝀯}
  \def\tria{𝀰}
  \def\tessera{𝀱}
  \def\kratimata{𝀲}
  \def\apesoexoneo{𝀳}
  \def\fthoraarchaion{𝀴}
  \def\imifthora{𝀵}
  \def\tromikonarchaion{𝀶}
  \def\katavatromikon{𝀷}
  \def\pelaston{𝀸}
  \def\psifistonar{𝀹}
  \def\kontevma{𝀺}
  \def\chorevmaarchaion{𝀻}
  \def\rapisma{𝀼}
  \def\parakalesmaarchaion{𝀽}
  \def\paraklitikiarchaion{𝀾}
  \def\ichadin{𝀿}
  \def\nana{𝁀}
  \def\petasma{𝁁}
  \def\kontevmaallo{𝁂}
  \def\tromikonallo{𝁃}
  \def\straggismata{𝁄}
  \def\gronthismata{𝁅}
  \def\is{𝁆}
  \def\olig{𝁇}
  \def\oksia{𝁈}
  \def\pet{𝁉}
  \def\koufisma{𝁊}
  \def\petastokoufisma{𝁋}
  \def\kratimokoufisma{𝁌}
  \def\pelastonneo{𝁍}
  \def\ypsiliaristera{𝁎}
  \def\ypsilimeso{𝁏}
  \def\ypsili{𝁐}
  \def\apo{𝁑}
  \def\apostrofoisyndesmosneo{𝁒}
  \def\yp{𝁓}
  \def\kratimoyporroon{𝁔}
  \def\el{𝁕}
  \def\xa{𝁖}
  \def\mikronis{𝁗}
  \def\var{𝁘}
  \def\piasmaneo{𝁙}
  \def\psifiston{𝁚}
  \def\omalon{𝁛}
  \def\antikenoma{𝁜}
  \def\lygisma{𝁝}
  \def\paraklitikineo{𝁞}
  \def\parakalesmaneo{𝁟}
  \def\eteron{𝁠}
  \def\kylisma{𝁡}
  \def\antikenokylisma{𝁢}
  \def\tromikonneo{𝁣}
  \def\ekstrepton{𝁤}
  \def\synagmaneo{𝁥}
  \def\syrma{𝁦}
  \def\chorevmaneo{𝁧}
  \def\epegerma{𝁨}
  \def\seismaneo{𝁩}
  \def\xironklasma{𝁪}
  \def\tromikopsifiston{𝁫}
  \def\psifistolygisma{𝁬}
  \def\tromikolygisma{𝁭}
  \def\tromikoparakalesma{𝁮}
  \def\psifistoparakalesma{𝁯}
  \def\tromikosynagma{𝁰}
  \def\psifistosynagma{𝁱}
  \def\gorgosyntheton{𝁲}
  \def\argosyntheton{𝁳}
  \def\eteronargosyntheton{𝁴}
  \def\oyranismaneo{𝁵}
  \def\thematismaseso{𝁶}
  \def\thematismosexo{𝁷}
  \def\themaaploun{𝁸}
  \def\theskaiapothes{𝁹}
  \def\katavasma{𝁺}
  \def\endofonon{𝁻}
  \def\yfenkato{𝁼}
  \def\yfenano{𝁽}
  \def\stavros{𝁾}
  \def\klasmaano{𝁿}
  \def\dipliar{𝂀}
  \def\kratimaarchaion{𝂁}
  \def\kratimaallo{𝂂}
  \def\kratimaneo{𝂃}
  \def\apodermaneo{𝂄}
  \def\apli{𝂅}
  \def\dipli{𝂆}
  \def\tripli{𝂇}
  \def\tetrapli{𝂈}
  \def\koronisbyz{𝂉}
  \def\leimmaenoschronou{𝂊}
  \def\leimmadyochronon{𝂋}
  \def\leimmatrionchronon{𝂌}
  \def\leimmatessaronchronon{𝂍}
  \def\leimmaimiseoschronou{𝂎}
  \def\gorgon{{\ruh 𝂏}}
  \def\gorgonparestigmenonaristera{{\ruh𝂐}}
  \def\gorgonparestigmenondexia{{\ruh𝂑}}
  \def\digorgon{{\ruh 𝂒}}
  \def\digorgparestigmaristerkato{{\ruh𝂓}}
  \def\digorgparestigmaristerano{{\ruh𝂔}}
  \def\digorgonparestigmenondexia{{\ruh𝂕}}
  \def\trigorgon{{\ruh 𝂖}}
  \def\argon{{\ruh𝂗}}
  \def\imidiargon{{\ruh𝂘}}
  \def\diargon{{\ruh𝂙}}
  \def\agogipoliargi{{\ruh𝂚}}
  \def\agogiargoteri{{\ruh𝂛}}
  \def\agogiargi{{\ruh𝂜}}
  \def\agogimetria{{\ruh𝂝}}
  \def\anooksia{{\ruh𝂞}}
  \def\agogigorgi{{\ruh𝂟}}
  \def\agogigorgoteri{{\ruh𝂠}}
  \def\agogipoligorgi{{\ruh𝂡}}
  \def\mpa{{\ruh 𝂢}}
  \def\mp{{\ruh 𝂣}}
  \def\mda{{\ruh 𝂤}}
  \def\mdb{{\ruh 𝂥}}
  \def\mt{{\ruh 𝂦}}
  \def\mtri{{\ruh 𝂧}}
  \def\mtet{{\ruh 𝂨}}
  \def\mleg{{\ruh 𝂩}}
  \def\mlegetos{{\ruh 𝂪}}
  \def\mpl{{\ruh 𝂫}}
  \def\istelichi{{\ruh 𝂬}}
  \def\mapos{{\ruh 𝂭}}
  \def\fantetra{{\ruh 𝂮}}
  \def\fanmono{{\ruh 𝂯\hspace{0.2em}}}
  \def\fandifon{{\ruh 𝂰}}
  \def\mvar{{\ruh 𝂱}}
  \def\mprotovarys{{\ruh 𝂲}}
  \def\mpltet{{\ruh 𝂳}}
  \def\moda{𝂴}
  \def\modb{𝂵}
  \def\fb{{\ruh 𝂶}}
  \def\imifonon{{\ruh 𝂷}}
  \def\imifthoron{{\ruh 𝂸}}
  \def\fda{{\ruh 𝂹}}
  \def\fp{{\ruh 𝂺}}
  \def\fg{{\ruh 𝂻}}
  \def\naos{{\ruh 𝂼}}
  \def\fd{{\ruh 𝂽}}
  \def\ms{{\ruh 𝂾}}
  \def\fk{{\ruh 𝂿}}
  \def\fz{{\ruh 𝃀}}
  \def\fn{{\ruh 𝃁}}
  \def\fna{{\ruh 𝃂}}
  \def\fm{{\ruh 𝃃}}
  \def\mm{{\ruh 𝃄}}
  \def\fs{{\ruh 𝃅}}
  \def\fmk{{\ruh 𝃆}}
  \def\fnenano{{\ruh 𝃇}}
  \def\chrzygos{{\ruh 𝃈}}
  \def\chrkliton{{\ruh 𝃉}}
  \def\chrspathi{{\ruh 𝃊}}
  \def\fen{{\ruh 𝃋}}
  \def\fenantifonia{{\ruh 𝃌}}
  \def\omalonapo{𝃍}
  \def\omalonol{𝃎}
  \def\omalonkn{𝃏}
  \def\d{{\ruh 𝃐}}
  \def\dd{{\ruh 𝃑}}
  \def\ddd{{\ruh 𝃒}}
  \def\dddd{{\ruh 𝃓}}
  \def\y{{\ruh 𝃔}}
  \def\yy{{\ruh 𝃕}}
  \def\yyy{{\ruh 𝃖}}
  \def\yyyy{{\ruh 𝃗}}
  \def\genikidiesis{{\ruh 𝃘}}
  \def\genikiyfesis{{\ruh 𝃙}}
  \def\diastolimikri{{\ruh 𝃚}}
  \def\diastoli{{\ruh 𝃛}}
  \def\diastolidipli{{\ruh 𝃜}}
  \def\diastolitheseos{{\ruh 𝃝}}
  \def\ism{{\ruh𝃞}}
  \def\isd{{\ruh𝃟}}
  \def\isk{{\ruh𝃠}}
  \def\isz{{\ruh𝃡}}
  \def\isn{{\ruh𝃢}}
  \def\isp{{\ruh𝃣}}
  \def\isB{{\ruh𝃤}}
  \def\isG{{\ruh𝃥}}
  \def\isD{{\ruh𝃦}}
  \def\isK{{\ruh𝃧}}
  \def\isZ{{\ruh𝃨}}
  \def\apa{{\ruh 𝃩}}
  \def\avu{{\ruh 𝃪}}
  \def\aga{{\ruh 𝃫}}
  \def\adi{{\ruh 𝃬}}
  \def\ake{{\ruh 𝃭}}
  \def\azo{{\ruh 𝃮}}
  \def\ani{{\ruh 𝃯}}
  \def\knta{𝃰}
  \def\kn{𝃱}
  \def\kntakato{𝃲}
  \def\knkato{𝃳}
  \def\klasmakato{𝃴}
  \def\gorgonkato{𝃵}
  \def\zwj{‍}
  \def\wj{⁠}
  \def\zwsp{​}
}{}
\newenvironment{troparion}{}{}
\newenvironment{neume}{
  \fontsize{\NeumeFontSize}{\NeumeFontSize}\NeumeFont
  \byzmacros
}{}

\ExplSyntaxOn
\tl_new:N \l__blackened_test_tl
\@ifpackageloaded{luacolor}
{
  \NewDocumentEnvironment{NeumeColor}{+b}
  {
    \tl_set:Nn \l__blackened_test_tl { #1 }
    % TODO
      \regex_replace_all:nnN{NEUMESYMBOL}{\c{NEUMENAME}}\l__blackened_test_tl
    \tl_use:N \l__blackened_test_tl
  }{}
  \ExplSyntaxOff
}{\newenvironment{NeumeColor}{}{}}
