% Áelou! Káevarju dúing?  This is my first package ever and if it is
% beneficial to you, then I am very happy, my frjénding.
%
% (c) Anastázius Kaejatí Darián
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{psaltiki}
\RequirePackage{fontspec,setspace,stackengine,varwidth,luacode,luatexbase}

\@ifpackageloaded{xcolor}{\providecommand\ruh{\color{red}}}{}
\@ifpackageloaded{luacolor}{\providecommand\nruh{\color{red}}\providecommand\ruh{\nruh}}{}
\providecommand\ruh{}\providecommand\nruh{}

\providecommand\defaulthxostext{Ἧχος}
\providecommand\hxosfonthook{\greekfont}
\providecommand\texthxos[4][\defaulthxostext]{{
  \unskip\ruh\nruh
  \unskip\let\NeumeFontScaleFactor\NeumeFontScaleFactorHxos\NeumeAutoResize
  {\hxosfonthook #1 }
  {\neume #2}
  {\hxosfonthook #3 }
  {\neume #4 }
}}
\providecommand\foretext[1]{{\centering\nruh\ruh #1\par\vspace{-\parskip}}}
\providecommand\hxos[4][\defaulthxostext]{\foretext{\texthxos[#1]{#2}{#3}{#4}}}
\providecommand\smallhxos[4][\defaulthxostext]{{
  \setlength\parskip{0.5\parskip}
  \setstretch{0.6}
  \hxos[#1]{#2}{#3}{#4}
}}
\newlength\NeumeAlignment
\newlength\NeumePadding
\newlength\NeumeTextPadding
\newlength\NeumeComboPadding

\providecommand\NeumeFontScaleFactor{5}
\providecommand\NeumeFontScaleFactorHxos{2.6}
\providecommand\NeumeFontScaleFactorInline{2.4}
\providecommand\NeumeAlignmentScaleFactor{-0.2}
\providecommand\NeumePaddingScaleFactor{0}
\providecommand\NeumeTextPaddingScaleFactor{0}
\providecommand\NeumeComboPaddingScaleFactor{0}
\providecommand\DropcapScaleFactor{6}
\providecommand\NeumeAutoResize{
  \unskip\setlength\tmpFontSize{\f@size pt}
  \unskip\setlength\NeumeFontSize    {\NeumeFontScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeAlignment   {\NeumeAlignmentScaleFactor\tmpFontSize}
  \unskip\setlength\NeumePadding     {\NeumePaddingScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeTextPadding {\NeumeTextPaddingScaleFactor\tmpFontSize}
  \unskip\setlength\NeumeComboPadding{\NeumeComboPaddingScaleFactor\tmpFontSize}
  \unskip\ignorespaces
}
\def\storefirstletter #1#2 {
  \ifcat\noexpand\relax\noexpand#1\def\next{#1{#2}\storefirstletter}\else
  \def\next{\def\firstletter{#1}\def\firstletterremainder{#2}}\fi
  \next
}
\providecommand\dropfont{}
\providecommand\neumedropcommand[1]{{
  \unskip\NeumeAutoResize
  \unskip\dropfont\scshape\ruh\fontsize{\DropcapScaleFactor\tmpFontSize}
  {\DropcapScaleFactor\tmpFontSize}\selectfont\ignorespaces #1 \unskip\hspace{-\NeumeAlignment}\ignorespaces
}}
\providecommand\dropstack[2][\_]{{
  \unskip\storefirstletter #1
  \unskip\neumedropcommand{\firstletter}
  \unskip\neumestack[\scshape\firstletterremainder]{\ignorespaces #2 \unskip}\ignorespaces
}}
\newfontface\NeumeFont{SERAFIM+}
\newlength\tmpFontSize
\newlength\NeumeFontSize
\newlength\tmpStackFontSize
\NeumeAutoResize
\providecommand\neumestack[2][\_]{
  \unskip\renewcommand\stackalignment{c}
  \unskip\renewcommand\stacktype{L}
  \unskip\stackon{\strut\hspace{0.5\NeumeTextPadding}
  \unskip\ignorespaces #1 \unskip\hspace{0.5\NeumeTextPadding}}{
    \unskip{\neume\strut\hspace{\NeumeAlignment}\hspace{0.5\NeumePadding}
    \unskip\ignorespaces #2 \unskip\hspace{-\NeumeAlignment}\hspace{0.5\NeumePadding}}\ignorespaces
  }\hspace{\NeumeComboPadding}{\fontsize{0.5\tmpFontSize}{0.5\tmpFontSize}\selectfont{ }}\ignorespaces
}
\providecommand\annotate[2]{
  \unskip\renewcommand\stacktype{S}
  \unskip\renewcommand\stackalignment{l}
  \unskip\setlength\tmpStackFontSize{\f@size pt}
  \unskip\stackon{\ignorespaces #1 \unskip}{
    \unskip\fontsize{0.5\tmpStackFontSize}{0.5\tmpStackFontSize}\selectfont
    \unskip\begin{varwidth}[t][5ex][t]{\textwidth}
      \unskip\ \\*[-2ex]
      \unskip\ruh{\ignorespaces #2 \unskip}
    \unskip\end{varwidth}\ignorespaces
  }\ignorespaces
}
\newenvironment{byzmacros}{
  \unskip\def\daseia{𝀁}
  \unskip\def\perispomeni{𝀂}
  \unskip\def\oxeiaekfonitikon{𝀃}
  \unskip\def\oxeiadipli{𝀄}
  \unskip\def\vareiaekfonitikon{𝀅}
  \unskip\def\vareiadipli{𝀆}
  \unskip\def\kathisti{𝀇}
  \unskip\def\syrmatiki{𝀈}
  \unskip\def\paraklitiki{𝀉}
  \unskip\def\ypokrisis{𝀊}
  \unskip\def\ypokrisisdipli{𝀋}
  \unskip\def\kremasti{𝀌}
  \unskip\def\apesoekfonitikon{𝀍}
  \unskip\def\exoekfonitikon{𝀎}
  \unskip\def\teleia{𝀏}
  \unskip\def\kntaek{𝀐}
  \unskip\def\apostrofos{𝀑}
  \unskip\def\apostrofosdipli{𝀒}
  \unskip\def\synevma{𝀓}
  \unskip\def\thita{𝀔}
  \unskip\def\oligarchaion{𝀕}
  \unskip\def\gorgonarchaion{𝀖}
  \unskip\def\psilon{𝀗}
  \unskip\def\chamilon{𝀘}
  \unskip\def\vathy{𝀙}
  \unskip\def\isarchaion{𝀚}
  \unskip\def\knarchaion{𝀛}
  \unskip\def\kntaekarchaion{𝀜}
  \unskip\def\saximata{𝀝}
  \unskip\def\parichon{𝀞}
  \unskip\def\stavrosapodexia{𝀟}
  \unskip\def\oxeiaarchaion{𝀠}
  \unskip\def\vareiaiarchaion{𝀡}
  \unskip\def\apodermaarchaion{𝀢}
  \unskip\def\apothema{𝀣}
  \unskip\def\klasma{𝀤}
  \unskip\def\revma{𝀥}
  \unskip\def\piasmaarchaion{𝀦}
  \unskip\def\tinagma{𝀧}
  \unskip\def\anatrichisma{𝀨}
  \unskip\def\seisma{𝀩}
  \unskip\def\synagmaarchaion{𝀪}
  \unskip\def\synagmametastavrou{𝀫}
  \unskip\def\oyranismaarchaion{𝀬}
  \unskip\def\thema{𝀭}
  \unskip\def\lemoi{𝀮}
  \unskip\def\dyo{𝀯}
  \unskip\def\tria{𝀰}
  \unskip\def\tessera{𝀱}
  \unskip\def\kratimata{𝀲}
  \unskip\def\apesoexoneo{𝀳}
  \unskip\def\fthoraarchaion{𝀴}
  \unskip\def\imifthora{𝀵}
  \unskip\def\tromikonarchaion{𝀶}
  \unskip\def\katavatromikon{𝀷}
  \unskip\def\pelaston{𝀸}
  \unskip\def\psifistonar{𝀹}
  \unskip\def\kontevma{𝀺}
  \unskip\def\chorevmaarchaion{𝀻}
  \unskip\def\rapisma{𝀼}
  \unskip\def\parakalesmaarchaion{𝀽}
  \unskip\def\paraklitikiarchaion{𝀾}
  \unskip\def\ichadin{𝀿}
  \unskip\def\nana{𝁀}
  \unskip\def\petasma{𝁁}
  \unskip\def\kontevmaallo{𝁂}
  \unskip\def\tromikonallo{𝁃}
  \unskip\def\straggismata{𝁄}
  \unskip\def\gronthismata{𝁅}
  \unskip\def\is{𝁆}
  \unskip\def\olig{𝁇}
  \unskip\def\oksia{𝁈}
  \unskip\def\pet{𝁉}
  \unskip\def\koufisma{𝁊}
  \unskip\def\petastokoufisma{𝁋}
  \unskip\def\kratimokoufisma{𝁌}
  \unskip\def\pelastonneo{𝁍}
  \unskip\def\ypsiliaristera{𝁎}
  \unskip\def\ypsilimeso{𝁏}
  \unskip\def\ypsili{𝁐}
  \unskip\def\apo{𝁑}
  \unskip\def\apostrofoisyndesmosneo{𝁒}
  \unskip\def\yp{𝁓}
  \unskip\def\kratimoyporroon{𝁔}
  \unskip\def\el{𝁕}
  \unskip\def\xa{𝁖}
  \unskip\def\mikronis{𝁗}
  \unskip\def\var{𝁘}
  \unskip\def\piasmaneo{𝁙}
  \unskip\def\psifiston{𝁚}
  \unskip\def\omalon{𝁛}
  \unskip\def\antikenoma{𝁜}
  \unskip\def\lygisma{𝁝}
  \unskip\def\paraklitikineo{𝁞}
  \unskip\def\parakalesmaneo{𝁟}
  \unskip\def\eteron{𝁠}
  \unskip\def\kylisma{𝁡}
  \unskip\def\antikenokylisma{𝁢}
  \unskip\def\tromikonneo{𝁣}
  \unskip\def\ekstrepton{𝁤}
  \unskip\def\synagmaneo{𝁥}
  \unskip\def\syrma{𝁦}
  \unskip\def\chorevmaneo{𝁧}
  \unskip\def\epegerma{𝁨}
  \unskip\def\seismaneo{𝁩}
  \unskip\def\xironklasma{𝁪}
  \unskip\def\tromikopsifiston{𝁫}
  \unskip\def\psifistolygisma{𝁬}
  \unskip\def\tromikolygisma{𝁭}
  \unskip\def\tromikoparakalesma{𝁮}
  \unskip\def\psifistoparakalesma{𝁯}
  \unskip\def\tromikosynagma{𝁰}
  \unskip\def\psifistosynagma{𝁱}
  \unskip\def\gorgosyntheton{𝁲}
  \unskip\def\argosyntheton{𝁳}
  \unskip\def\eteronargosyntheton{𝁴}
  \unskip\def\oyranismaneo{𝁵}
  \unskip\def\thematismaseso{𝁶}
  \unskip\def\thematismosexo{𝁷}
  \unskip\def\themaaploun{𝁸}
  \unskip\def\theskaiapothes{𝁹}
  \unskip\def\katavasma{𝁺}
  \unskip\def\endofonon{𝁻}
  \unskip\def\yfenkato{𝁼}
  \unskip\def\yfenano{𝁽}
  \unskip\def\stavros{𝁾}
  \unskip\def\klasmaano{𝁿}
  \unskip\def\dipliar{𝂀}
  \unskip\def\kratimaarchaion{𝂁}
  \unskip\def\kratimaallo{𝂂}
  \unskip\def\kratimaneo{𝂃}
  \unskip\def\apodermaneo{𝂄}
  \unskip\def\apli{𝂅}
  \unskip\def\dipli{𝂆}
  \unskip\def\tripli{𝂇}
  \unskip\def\tetrapli{𝂈}
  \unskip\def\koronisbyz{𝂉}
  \unskip\def\leimmaenoschronou{𝂊}
  \unskip\def\leimmadyochronon{𝂋}
  \unskip\def\leimmatrionchronon{𝂌}
  \unskip\def\leimmatessaronchronon{𝂍}
  \unskip\def\leimmaimiseoschronou{𝂎}
  \unskip\def\gorgon{{\nruh 𝂏}}
  \unskip\def\gorgonparestigmenonaristera{{\nruh𝂐}}
  \unskip\def\gorgonparestigmenondexia{{\nruh𝂑}}
  \unskip\def\digorgon{{\nruh 𝂒}}
  \unskip\def\digorgparestigmaristerkato{{\nruh𝂓}}
  \unskip\def\digorgparestigmaristerano{{\nruh𝂔}}
  \unskip\def\digorgonparestigmenondexia{{\nruh𝂕}}
  \unskip\def\trigorgon{{\nruh 𝂖}}
  \unskip\def\argon{{\nruh𝂗}}
  \unskip\def\imidiargon{{\nruh𝂘}}
  \unskip\def\diargon{{\nruh𝂙}}
  \unskip\def\agogipoliargi{{\nruh𝂚}}
  \unskip\def\agogiargoteri{{\nruh𝂛}}
  \unskip\def\agogiargi{{\nruh𝂜}}
  \unskip\def\agogimetria{{\nruh𝂝}}
  \unskip\def\anooksia{{\nruh𝂞}}
  \unskip\def\agogigorgi{{\nruh𝂟}}
  \unskip\def\agogigorgoteri{{\nruh𝂠}}
  \unskip\def\agogipoligorgi{{\nruh𝂡}}
  \unskip\def\mpa{{\nruh 𝂢}}
  \unskip\def\mp{{\nruh 𝂣}}
  \unskip\def\mda{{\nruh 𝂤}}
  \unskip\def\mdb{{\nruh 𝂥}}
  \unskip\def\mt{{\nruh 𝂦}}
  \unskip\def\mtri{{\nruh 𝂧}}
  \unskip\def\mtet{{\nruh 𝂨}}
  \unskip\def\mleg{{\nruh 𝂩}}
  \unskip\def\mlegetos{{\nruh 𝂪}}
  \unskip\def\mpl{{\nruh 𝂫}}
  \unskip\def\istelichi{{\nruh 𝂬}}
  \unskip\def\mapos{{\nruh 𝂭}}
  \unskip\def\fantetra{{\nruh 𝂮}}
  \unskip\def\fanmono{{\nruh 𝂯}}
  \unskip\def\fandifon{{\nruh 𝂰}}
  \unskip\def\mvar{{\nruh 𝂱}}
  \unskip\def\mprotovarys{{\nruh 𝂲}}
  \unskip\def\mpltet{{\nruh 𝂳}}
  \unskip\def\moda{𝂴}
  \unskip\def\modb{𝂵}
  \unskip\def\fb{{\nruh 𝂶}}
  \unskip\def\imifonon{{\nruh 𝂷}}
  \unskip\def\imifthoron{{\nruh 𝂸}}
  \unskip\def\fda{{\nruh 𝂹}}
  \unskip\def\fp{{\nruh 𝂺}}
  \unskip\def\fg{{\nruh 𝂻}}
  \unskip\def\naos{{\nruh 𝂼}}
  \unskip\def\fd{{\nruh 𝂽}}
  \unskip\def\ms{{\nruh 𝂾}}
  \unskip\def\fk{{\nruh 𝂿}}
  \unskip\def\fz{{\nruh 𝃀}}
  \unskip\def\fn{{\nruh 𝃁}}
  \unskip\def\fna{{\nruh 𝃂}}
  \unskip\def\fm{{\nruh 𝃃}}
  \unskip\def\mm{{\nruh 𝃄}}
  \unskip\def\fs{{\nruh 𝃅}}
  \unskip\def\fmk{{\nruh 𝃆}}
  \unskip\def\fnenano{{\nruh 𝃇}}
  \unskip\def\chrzygos{{\nruh 𝃈}}
  \unskip\def\chrkliton{{\nruh 𝃉}}
  \unskip\def\chrspathi{{\nruh 𝃊}}
  \unskip\def\fen{{\nruh 𝃋}}
  \unskip\def\fenantifonia{{\nruh 𝃌}}
  \unskip\def\omalonapo{𝃍}
  \unskip\def\omalonol{𝃎}
  \unskip\def\omalonkn{𝃏}
  \unskip\def\d{{\nruh 𝃐}}
  \unskip\def\dd{{\nruh 𝃑}}
  \unskip\def\ddd{{\nruh 𝃒}}
  \unskip\def\dddd{{\nruh 𝃓}}
  \unskip\def\y{{\nruh 𝃔}}
  \unskip\def\yy{{\nruh 𝃕}}
  \unskip\def\yyy{{\nruh 𝃖}}
  \unskip\def\yyyy{{\nruh 𝃗}}
  \unskip\def\genikidiesis{{\nruh 𝃘}}
  \unskip\def\genikiyfesis{{\nruh 𝃙}}
  \unskip\def\diastolimikri{{\nruh 𝃚}}
  \unskip\def\diastoli{{\nruh 𝃛}}
  \unskip\def\diastolidipli{{\nruh 𝃜}}
  \unskip\def\diastolitheseos{{\nruh 𝃝}}
  \unskip\def\ism{{\nruh𝃞}}
  \unskip\def\isd{{\nruh𝃟}}
  \unskip\def\isk{{\nruh𝃠}}
  \unskip\def\isz{{\nruh𝃡}}
  \unskip\def\isn{{\nruh𝃢}}
  \unskip\def\isp{{\nruh𝃣}}
  \unskip\def\isB{{\nruh𝃤}}
  \unskip\def\isG{{\nruh𝃥}}
  \unskip\def\isD{{\nruh𝃦}}
  \unskip\def\isK{{\nruh𝃧}}
  \unskip\def\isZ{{\nruh𝃨}}
  \unskip\def\apa{{\nruh 𝃩}}
  \unskip\def\avu{{\nruh 𝃪}}
  \unskip\def\aga{{\nruh 𝃫}}
  \unskip\def\adi{{\nruh 𝃬}}
  \unskip\def\ake{{\nruh 𝃭}}
  \unskip\def\azo{{\nruh 𝃮}}
  \unskip\def\ani{{\nruh 𝃯}}
  \unskip\def\knta{𝃰}
  \unskip\def\kn{𝃱}
  \unskip\def\kntakato{𝃲}
  \unskip\def\knkato{𝃳}
  \unskip\def\klasmakato{𝃴}
  \unskip\def\gorgonkato{𝃵}
  \unskip\def\zwj{‍}
  \unskip\def\wj{⁠}
  \unskip\def\zwsp{​}
  \unskip\ignorespaces
}{}
\newenvironment{troparion}{}{}
\newenvironment{neume}{
  \unskip\fontsize{\NeumeFontSize}{\NeumeFontSize}\NeumeFont
  \unskip\byzmacros\ignorespaces
}{\unskip\ignorespaces}

%% Lua-side code
\begin{luacode}
function sometexttocommand ( line )
    line = string.gsub ( line , "𝂏", "\\gorgon" )
    line = string.gsub ( line , "𝂐", "\\gorgonparestigmenonaristera" )
    line = string.gsub ( line , "𝂑", "\\gorgonparestigmenondexia" )
    line = string.gsub ( line , "𝂒", "\\digorgon" )
    line = string.gsub ( line , "𝂓", "\\digorgparestigmaristerkato" )
    line = string.gsub ( line , "𝂔", "\\digorgparestigmaristerano" )
    line = string.gsub ( line , "𝂕", "\\digorgonparestigmenondexia" )
    line = string.gsub ( line , "𝂖", "\\trigorgon" )
    line = string.gsub ( line , "𝂗", "\\argon" )
    line = string.gsub ( line , "𝂘", "\\imidiargon" )
    line = string.gsub ( line , "𝂙", "\\diargon" )
    line = string.gsub ( line , "𝂚", "\\agogipoliargi" )
    line = string.gsub ( line , "𝂛", "\\agogiargoteri" )
    line = string.gsub ( line , "𝂜", "\\agogiargi" )
    line = string.gsub ( line , "𝂝", "\\agogimetria" )
    line = string.gsub ( line , "𝂞", "\\anooksia" )
    line = string.gsub ( line , "𝂟", "\\agogigorgi" )
    line = string.gsub ( line , "𝂠", "\\agogigorgoteri" )
    line = string.gsub ( line , "𝂡", "\\agogipoligorgi" )
    line = string.gsub ( line , "𝂢", "\\mpa" )
    line = string.gsub ( line , "𝂣", "\\mp" )
    line = string.gsub ( line , "𝂤", "\\mda" )
    line = string.gsub ( line , "𝂥", "\\mdb" )
    line = string.gsub ( line , "𝂦", "\\mt" )
    line = string.gsub ( line , "𝂧", "\\mtri" )
    line = string.gsub ( line , "𝂨", "\\mtet" )
    line = string.gsub ( line , "𝂩", "\\mleg" )
    line = string.gsub ( line , "𝂪", "\\mlegetos" )
    line = string.gsub ( line , "𝂫", "\\mpl" )
    line = string.gsub ( line , "𝂬", "\\istelichi" )
    line = string.gsub ( line , "𝂭", "\\mapos" )
    line = string.gsub ( line , "𝂮", "\\fantetra" )
    line = string.gsub ( line , "𝂯", "\\fanmono" )
    line = string.gsub ( line , "𝂰", "\\fandifon" )
    line = string.gsub ( line , "𝂱", "\\mvar" )
    line = string.gsub ( line , "𝂲", "\\mprotovarys" )
    line = string.gsub ( line , "𝂳", "\\mpltet" )
    line = string.gsub ( line , "𝂶", "\\fb" )
    line = string.gsub ( line , "𝂷", "\\imifonon" )
    line = string.gsub ( line , "𝂸", "\\imifthoron" )
    line = string.gsub ( line , "𝂹", "\\fda" )
    line = string.gsub ( line , "𝂺", "\\fp" )
    line = string.gsub ( line , "𝂻", "\\fg" )
    line = string.gsub ( line , "𝂼", "\\naos" )
    line = string.gsub ( line , "𝂽", "\\fd" )
    line = string.gsub ( line , "𝂾", "\\ms" )
    line = string.gsub ( line , "𝂿", "\\fk" )
    line = string.gsub ( line , "𝃀", "\\fz" )
    line = string.gsub ( line , "𝃁", "\\fn" )
    line = string.gsub ( line , "𝃂", "\\fna" )
    line = string.gsub ( line , "𝃃", "\\fm" )
    line = string.gsub ( line , "𝃄", "\\mm" )
    line = string.gsub ( line , "𝃅", "\\fs" )
    line = string.gsub ( line , "𝃆", "\\fmk" )
    line = string.gsub ( line , "𝃇", "\\fnenano" )
    line = string.gsub ( line , "𝃈", "\\chrzygos" )
    line = string.gsub ( line , "𝃉", "\\chrkliton" )
    line = string.gsub ( line , "𝃊", "\\chrspathi" )
    line = string.gsub ( line , "𝃋", "\\fen" )
    line = string.gsub ( line , "𝃌", "\\fenantifonia" )
    line = string.gsub ( line , "𝃐", "\\d" )
    line = string.gsub ( line , "𝃑", "\\dd" )
    line = string.gsub ( line , "𝃒", "\\ddd" )
    line = string.gsub ( line , "𝃓", "\\dddd" )
    line = string.gsub ( line , "𝃔", "\\y" )
    line = string.gsub ( line , "𝃕", "\\yy" )
    line = string.gsub ( line , "𝃖", "\\yyy" )
    line = string.gsub ( line , "𝃗", "\\yyyy" )
    line = string.gsub ( line , "𝃘", "\\genikidiesis" )
    line = string.gsub ( line , "𝃙", "\\genikiyfesis" )
    line = string.gsub ( line , "𝃚", "\\diastolimikri" )
    line = string.gsub ( line , "𝃛", "\\diastoli" )
    line = string.gsub ( line , "𝃜", "\\diastolidipli" )
    line = string.gsub ( line , "𝃝", "\\diastolitheseos" )
    line = string.gsub ( line , "𝃞", "\\ism" )
    line = string.gsub ( line , "𝃟", "\\isd" )
    line = string.gsub ( line , "𝃠", "\\isk" )
    line = string.gsub ( line , "𝃡", "\\isz" )
    line = string.gsub ( line , "𝃢", "\\isn" )
    line = string.gsub ( line , "𝃣", "\\isp" )
    line = string.gsub ( line , "𝃤", "\\isB" )
    line = string.gsub ( line , "𝃥", "\\isG" )
    line = string.gsub ( line , "𝃦", "\\isD" )
    line = string.gsub ( line , "𝃧", "\\isK" )
    line = string.gsub ( line , "𝃨", "\\isZ" )
    line = string.gsub ( line , "𝃩", "\\apa" )
    line = string.gsub ( line , "𝃪", "\\avu" )
    line = string.gsub ( line , "𝃫", "\\aga" )
    line = string.gsub ( line , "𝃬", "\\adi" )
    line = string.gsub ( line , "𝃭", "\\ake" )
    line = string.gsub ( line , "𝃮", "\\azo" )
    line = string.gsub ( line , "𝃯", "\\ani" )
    return ( line )
end
\end{luacode}

%% TeX-side code
\newenvironment{NeumeParseUnicode}{%
   \directlua{luatexbase.add_to_callback(
              "process_input_buffer",
              sometexttocommand, "sometexttocommand")}}{%
   \directlua{luatexbase.remove_from_callback(
              "process_input_buffer",
              "sometexttocommand")}}
