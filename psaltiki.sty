% Ãelou! KÃ¡evarju dÃºing?  This is my first package ever and if it is
% beneficial to you, then I am very happy, my frjÃ©nding.
%
% (c) AnastÃ¡zius KaejatÃ­ DariÃ¡n
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{psaltiki}
\RequirePackage{fontspec,stackengine,varwidth,luacode,luatexbase}

\@ifpackageloaded{xcolor}{\providecommand\ruh{\color{red}}}{}
\@ifpackageloaded{luacolor}{\providecommand\ruh{\color{red}}\providecommand\nruh{\ruh}}{}
\providecommand\ruh{}\providecommand\nruh{}

\newcommand\needspacecommandwrapper[1]{}
\@ifpackageloaded{needspace}{
  \renewcommand\needspacecommandwrapper[1]{\Needspace*{#1}}
}{}
\newcommand\hxos[4][á¼¯Ï‡Î¿Ï‚]{
  \needspacecommandwrapper{6\baselineskip}
  {\centering\ruh
  \renewcommand\NeumeFontScaleFactor{2.5}\NeumeAutoResize
  #1
  {\neume #2}
  #3
  {\neume #4}
  \par
  }\nopagebreak
}
\newcommand\NeumeFontScaleFactor{5}
\newcommand\NeumeAutoResize{
  \setlength\tmpFontSize{\f@size pt}
  \setlength\NeumeFontSize{\NeumeFontScaleFactor\tmpFontSize}
}
\newfontface\NeumeFont{SERAFIM+}
\newlength\tmpFontSize
\newlength\NeumeFontSize
\NeumeAutoResize
\newlength\NeumeStackSpace\setlength\NeumeStackSpace{-0.65em}
\newcommand{\neumestack}[2][]{
  \renewcommand\stacktype{L}
  \stackon{\strut#1}{
    {\neume\strut#2}
  }\hspace{\NeumeStackSpace}
}
\newcommand{\annotate}[2]{
  \renewcommand\stacktype{S}
  \setlength\tmpFontSize{\f@size pt}
  \stackon{#2}{
    \fontsize{0.5\tmpFontSize}{0.5\tmpFontSize}\selectfont
    \begin{varwidth}[t][5ex][t]{\textwidth}
      \ \\*[-2ex]
      \ruh #1
    \end{varwidth}
  }
}
\newenvironment{byzmacros}{
  \def\daseia{ğ€}
  \def\perispomeni{ğ€‚}
  \def\oxeiaekfonitikon{ğ€ƒ}
  \def\oxeiadipli{ğ€„}
  \def\vareiaekfonitikon{ğ€…}
  \def\vareiadipli{ğ€†}
  \def\kathisti{ğ€‡}
  \def\syrmatiki{ğ€ˆ}
  \def\paraklitiki{ğ€‰}
  \def\ypokrisis{ğ€Š}
  \def\ypokrisisdipli{ğ€‹}
  \def\kremasti{ğ€Œ}
  \def\apesoekfonitikon{ğ€}
  \def\exoekfonitikon{ğ€}
  \def\teleia{ğ€}
  \def\kntaek{ğ€}
  \def\apostrofos{ğ€‘}
  \def\apostrofosdipli{ğ€’}
  \def\synevma{ğ€“}
  \def\thita{ğ€”}
  \def\oligarchaion{ğ€•}
  \def\gorgonarchaion{ğ€–}
  \def\psilon{ğ€—}
  \def\chamilon{ğ€˜}
  \def\vathy{ğ€™}
  \def\isarchaion{ğ€š}
  \def\knarchaion{ğ€›}
  \def\kntaekarchaion{ğ€œ}
  \def\saximata{ğ€}
  \def\parichon{ğ€}
  \def\stavrosapodexia{ğ€Ÿ}
  \def\oxeiaarchaion{ğ€ }
  \def\vareiaiarchaion{ğ€¡}
  \def\apodermaarchaion{ğ€¢}
  \def\apothema{ğ€£}
  \def\klasma{ğ€¤}
  \def\revma{ğ€¥}
  \def\piasmaarchaion{ğ€¦}
  \def\tinagma{ğ€§}
  \def\anatrichisma{ğ€¨}
  \def\seisma{ğ€©}
  \def\synagmaarchaion{ğ€ª}
  \def\synagmametastavrou{ğ€«}
  \def\oyranismaarchaion{ğ€¬}
  \def\thema{ğ€­}
  \def\lemoi{ğ€®}
  \def\dyo{ğ€¯}
  \def\tria{ğ€°}
  \def\tessera{ğ€±}
  \def\kratimata{ğ€²}
  \def\apesoexoneo{ğ€³}
  \def\fthoraarchaion{ğ€´}
  \def\imifthora{ğ€µ}
  \def\tromikonarchaion{ğ€¶}
  \def\katavatromikon{ğ€·}
  \def\pelaston{ğ€¸}
  \def\psifistonar{ğ€¹}
  \def\kontevma{ğ€º}
  \def\chorevmaarchaion{ğ€»}
  \def\rapisma{ğ€¼}
  \def\parakalesmaarchaion{ğ€½}
  \def\paraklitikiarchaion{ğ€¾}
  \def\ichadin{ğ€¿}
  \def\nana{ğ€}
  \def\petasma{ğ}
  \def\kontevmaallo{ğ‚}
  \def\tromikonallo{ğƒ}
  \def\straggismata{ğ„}
  \def\gronthismata{ğ…}
  \def\is{ğ†}
  \def\olig{ğ‡}
  \def\oksia{ğˆ}
  \def\pet{ğ‰}
  \def\koufisma{ğŠ}
  \def\petastokoufisma{ğ‹}
  \def\kratimokoufisma{ğŒ}
  \def\pelastonneo{ğ}
  \def\ypsiliaristera{ğ}
  \def\ypsilimeso{ğ}
  \def\ypsili{ğ}
  \def\apo{ğ‘}
  \def\apostrofoisyndesmosneo{ğ’}
  \def\yp{ğ“}
  \def\kratimoyporroon{ğ”}
  \def\el{ğ•}
  \def\xa{ğ–}
  \def\mikronis{ğ—}
  \def\var{ğ˜}
  \def\piasmaneo{ğ™}
  \def\psifiston{ğš}
  \def\omalon{ğ›}
  \def\antikenoma{ğœ}
  \def\lygisma{ğ}
  \def\paraklitikineo{ğ}
  \def\parakalesmaneo{ğŸ}
  \def\eteron{ğ }
  \def\kylisma{ğ¡}
  \def\antikenokylisma{ğ¢}
  \def\tromikonneo{ğ£}
  \def\ekstrepton{ğ¤}
  \def\synagmaneo{ğ¥}
  \def\syrma{ğ¦}
  \def\chorevmaneo{ğ§}
  \def\epegerma{ğ¨}
  \def\seismaneo{ğ©}
  \def\xironklasma{ğª}
  \def\tromikopsifiston{ğ«}
  \def\psifistolygisma{ğ¬}
  \def\tromikolygisma{ğ­}
  \def\tromikoparakalesma{ğ®}
  \def\psifistoparakalesma{ğ¯}
  \def\tromikosynagma{ğ°}
  \def\psifistosynagma{ğ±}
  \def\gorgosyntheton{ğ²}
  \def\argosyntheton{ğ³}
  \def\eteronargosyntheton{ğ´}
  \def\oyranismaneo{ğµ}
  \def\thematismaseso{ğ¶}
  \def\thematismosexo{ğ·}
  \def\themaaploun{ğ¸}
  \def\theskaiapothes{ğ¹}
  \def\katavasma{ğº}
  \def\endofonon{ğ»}
  \def\yfenkato{ğ¼}
  \def\yfenano{ğ½}
  \def\stavros{ğ¾}
  \def\klasmaano{ğ¿}
  \def\dipliar{ğ‚€}
  \def\kratimaarchaion{ğ‚}
  \def\kratimaallo{ğ‚‚}
  \def\kratimaneo{ğ‚ƒ}
  \def\apodermaneo{ğ‚„}
  \def\apli{ğ‚…}
  \def\dipli{ğ‚†}
  \def\tripli{ğ‚‡}
  \def\tetrapli{ğ‚ˆ}
  \def\koronisbyz{ğ‚‰}
  \def\leimmaenoschronou{ğ‚Š}
  \def\leimmadyochronon{ğ‚‹}
  \def\leimmatrionchronon{ğ‚Œ}
  \def\leimmatessaronchronon{ğ‚}
  \def\leimmaimiseoschronou{ğ‚}
  \def\gorgon{{\nruh ğ‚}}
  \def\gorgonparestigmenonaristera{{\nruhğ‚}}
  \def\gorgonparestigmenondexia{{\nruhğ‚‘}}
  \def\digorgon{{\nruh ğ‚’}}
  \def\digorgparestigmaristerkato{{\nruhğ‚“}}
  \def\digorgparestigmaristerano{{\nruhğ‚”}}
  \def\digorgonparestigmenondexia{{\nruhğ‚•}}
  \def\trigorgon{{\nruh ğ‚–}}
  \def\argon{{\nruhğ‚—}}
  \def\imidiargon{{\nruhğ‚˜}}
  \def\diargon{{\nruhğ‚™}}
  \def\agogipoliargi{{\nruhğ‚š}}
  \def\agogiargoteri{{\nruhğ‚›}}
  \def\agogiargi{{\nruhğ‚œ}}
  \def\agogimetria{{\nruhğ‚}}
  \def\anooksia{{\nruhğ‚}}
  \def\agogigorgi{{\nruhğ‚Ÿ}}
  \def\agogigorgoteri{{\nruhğ‚ }}
  \def\agogipoligorgi{{\nruhğ‚¡}}
  \def\mpa{{\nruh ğ‚¢}}
  \def\mp{{\nruh ğ‚£}}
  \def\mda{{\nruh ğ‚¤}}
  \def\mdb{{\nruh ğ‚¥}}
  \def\mt{{\nruh ğ‚¦}}
  \def\mtri{{\nruh ğ‚§}}
  \def\mtet{{\nruh ğ‚¨}}
  \def\mleg{{\nruh ğ‚©}}
  \def\mlegetos{{\nruh ğ‚ª}}
  \def\mpl{{\nruh ğ‚«}}
  \def\istelichi{{\nruh ğ‚¬}}
  \def\mapos{{\nruh ğ‚­}}
  \def\fantetra{{\nruh ğ‚®}}
  \def\fanmono{{\nruh ğ‚¯\hspace{0.2em}}}
  \def\fandifon{{\nruh ğ‚°}}
  \def\mvar{{\nruh ğ‚±}}
  \def\mprotovarys{{\nruh ğ‚²}}
  \def\mpltet{{\nruh ğ‚³}}
  \def\moda{ğ‚´}
  \def\modb{ğ‚µ}
  \def\fb{{\nruh ğ‚¶}}
  \def\imifonon{{\nruh ğ‚·}}
  \def\imifthoron{{\nruh ğ‚¸}}
  \def\fda{{\nruh ğ‚¹}}
  \def\fp{{\nruh ğ‚º}}
  \def\fg{{\nruh ğ‚»}}
  \def\naos{{\nruh ğ‚¼}}
  \def\fd{{\nruh ğ‚½}}
  \def\ms{{\nruh ğ‚¾}}
  \def\fk{{\nruh ğ‚¿}}
  \def\fz{{\nruh ğƒ€}}
  \def\fn{{\nruh ğƒ}}
  \def\fna{{\nruh ğƒ‚}}
  \def\fm{{\nruh ğƒƒ}}
  \def\mm{{\nruh ğƒ„}}
  \def\fs{{\nruh ğƒ…}}
  \def\fmk{{\nruh ğƒ†}}
  \def\fnenano{{\nruh ğƒ‡}}
  \def\chrzygos{{\nruh ğƒˆ}}
  \def\chrkliton{{\nruh ğƒ‰}}
  \def\chrspathi{{\nruh ğƒŠ}}
  \def\fen{{\nruh ğƒ‹}}
  \def\fenantifonia{{\nruh ğƒŒ}}
  \def\omalonapo{ğƒ}
  \def\omalonol{ğƒ}
  \def\omalonkn{ğƒ}
  \def\d{{\nruh ğƒ}}
  \def\dd{{\nruh ğƒ‘}}
  \def\ddd{{\nruh ğƒ’}}
  \def\dddd{{\nruh ğƒ“}}
  \def\y{{\nruh ğƒ”}}
  \def\yy{{\nruh ğƒ•}}
  \def\yyy{{\nruh ğƒ–}}
  \def\yyyy{{\nruh ğƒ—}}
  \def\genikidiesis{{\nruh ğƒ˜}}
  \def\genikiyfesis{{\nruh ğƒ™}}
  \def\diastolimikri{{\nruh ğƒš}}
  \def\diastoli{{\nruh ğƒ›}}
  \def\diastolidipli{{\nruh ğƒœ}}
  \def\diastolitheseos{{\nruh ğƒ}}
  \def\ism{{\nruhğƒ}}
  \def\isd{{\nruhğƒŸ}}
  \def\isk{{\nruhğƒ }}
  \def\isz{{\nruhğƒ¡}}
  \def\isn{{\nruhğƒ¢}}
  \def\isp{{\nruhğƒ£}}
  \def\isB{{\nruhğƒ¤}}
  \def\isG{{\nruhğƒ¥}}
  \def\isD{{\nruhğƒ¦}}
  \def\isK{{\nruhğƒ§}}
  \def\isZ{{\nruhğƒ¨}}
  \def\apa{{\nruh ğƒ©}}
  \def\avu{{\nruh ğƒª}}
  \def\aga{{\nruh ğƒ«}}
  \def\adi{{\nruh ğƒ¬}}
  \def\ake{{\nruh ğƒ­}}
  \def\azo{{\nruh ğƒ®}}
  \def\ani{{\nruh ğƒ¯}}
  \def\knta{ğƒ°}
  \def\kn{ğƒ±}
  \def\kntakato{ğƒ²}
  \def\knkato{ğƒ³}
  \def\klasmakato{ğƒ´}
  \def\gorgonkato{ğƒµ}
  \def\zwj{â€}
  \def\wj{â }
  \def\zwsp{â€‹}
}{}
\newenvironment{troparion}{}{}
\newenvironment{neume}{
  \fontsize{\NeumeFontSize}{\NeumeFontSize}\NeumeFont
  \byzmacros
}{}

%% Lua-side code
\begin{luacode}
function sometexttocommand ( line )
    line = string.gsub ( line , "ğ‚", "\\gorgon" )
    line = string.gsub ( line , "ğ‚", "\\gorgonparestigmenonaristera" )
    line = string.gsub ( line , "ğ‚‘", "\\gorgonparestigmenondexia" )
    line = string.gsub ( line , "ğ‚’", "\\digorgon" )
    line = string.gsub ( line , "ğ‚“", "\\digorgparestigmaristerkato" )
    line = string.gsub ( line , "ğ‚”", "\\digorgparestigmaristerano" )
    line = string.gsub ( line , "ğ‚•", "\\digorgonparestigmenondexia" )
    line = string.gsub ( line , "ğ‚–", "\\trigorgon" )
    line = string.gsub ( line , "ğ‚—", "\\argon" )
    line = string.gsub ( line , "ğ‚˜", "\\imidiargon" )
    line = string.gsub ( line , "ğ‚™", "\\diargon" )
    line = string.gsub ( line , "ğ‚š", "\\agogipoliargi" )
    line = string.gsub ( line , "ğ‚›", "\\agogiargoteri" )
    line = string.gsub ( line , "ğ‚œ", "\\agogiargi" )
    line = string.gsub ( line , "ğ‚", "\\agogimetria" )
    line = string.gsub ( line , "ğ‚", "\\anooksia" )
    line = string.gsub ( line , "ğ‚Ÿ", "\\agogigorgi" )
    line = string.gsub ( line , "ğ‚ ", "\\agogigorgoteri" )
    line = string.gsub ( line , "ğ‚¡", "\\agogipoligorgi" )
    line = string.gsub ( line , "ğ‚¢", "\\mpa" )
    line = string.gsub ( line , "ğ‚£", "\\mp" )
    line = string.gsub ( line , "ğ‚¤", "\\mda" )
    line = string.gsub ( line , "ğ‚¥", "\\mdb" )
    line = string.gsub ( line , "ğ‚¦", "\\mt" )
    line = string.gsub ( line , "ğ‚§", "\\mtri" )
    line = string.gsub ( line , "ğ‚¨", "\\mtet" )
    line = string.gsub ( line , "ğ‚©", "\\mleg" )
    line = string.gsub ( line , "ğ‚ª", "\\mlegetos" )
    line = string.gsub ( line , "ğ‚«", "\\mpl" )
    line = string.gsub ( line , "ğ‚¬", "\\istelichi" )
    line = string.gsub ( line , "ğ‚­", "\\mapos" )
    line = string.gsub ( line , "ğ‚®", "\\fantetra" )
    line = string.gsub ( line , "ğ‚¯", "\\fanmono" )
    line = string.gsub ( line , "ğ‚°", "\\fandifon" )
    line = string.gsub ( line , "ğ‚±", "\\mvar" )
    line = string.gsub ( line , "ğ‚²", "\\mprotovarys" )
    line = string.gsub ( line , "ğ‚³", "\\mpltet" )
    line = string.gsub ( line , "ğ‚¶", "\\fb" )
    line = string.gsub ( line , "ğ‚·", "\\imifonon" )
    line = string.gsub ( line , "ğ‚¸", "\\imifthoron" )
    line = string.gsub ( line , "ğ‚¹", "\\fda" )
    line = string.gsub ( line , "ğ‚º", "\\fp" )
    line = string.gsub ( line , "ğ‚»", "\\fg" )
    line = string.gsub ( line , "ğ‚¼", "\\naos" )
    line = string.gsub ( line , "ğ‚½", "\\fd" )
    line = string.gsub ( line , "ğ‚¾", "\\ms" )
    line = string.gsub ( line , "ğ‚¿", "\\fk" )
    line = string.gsub ( line , "ğƒ€", "\\fz" )
    line = string.gsub ( line , "ğƒ", "\\fn" )
    line = string.gsub ( line , "ğƒ‚", "\\fna" )
    line = string.gsub ( line , "ğƒƒ", "\\fm" )
    line = string.gsub ( line , "ğƒ„", "\\mm" )
    line = string.gsub ( line , "ğƒ…", "\\fs" )
    line = string.gsub ( line , "ğƒ†", "\\fmk" )
    line = string.gsub ( line , "ğƒ‡", "\\fnenano" )
    line = string.gsub ( line , "ğƒˆ", "\\chrzygos" )
    line = string.gsub ( line , "ğƒ‰", "\\chrkliton" )
    line = string.gsub ( line , "ğƒŠ", "\\chrspathi" )
    line = string.gsub ( line , "ğƒ‹", "\\fen" )
    line = string.gsub ( line , "ğƒŒ", "\\fenantifonia" )
    line = string.gsub ( line , "ğƒ", "\\d" )
    line = string.gsub ( line , "ğƒ‘", "\\dd" )
    line = string.gsub ( line , "ğƒ’", "\\ddd" )
    line = string.gsub ( line , "ğƒ“", "\\dddd" )
    line = string.gsub ( line , "ğƒ”", "\\y" )
    line = string.gsub ( line , "ğƒ•", "\\yy" )
    line = string.gsub ( line , "ğƒ–", "\\yyy" )
    line = string.gsub ( line , "ğƒ—", "\\yyyy" )
    line = string.gsub ( line , "ğƒ˜", "\\genikidiesis" )
    line = string.gsub ( line , "ğƒ™", "\\genikiyfesis" )
    line = string.gsub ( line , "ğƒš", "\\diastolimikri" )
    line = string.gsub ( line , "ğƒ›", "\\diastoli" )
    line = string.gsub ( line , "ğƒœ", "\\diastolidipli" )
    line = string.gsub ( line , "ğƒ", "\\diastolitheseos" )
    line = string.gsub ( line , "ğƒ", "\\ism" )
    line = string.gsub ( line , "ğƒŸ", "\\isd" )
    line = string.gsub ( line , "ğƒ ", "\\isk" )
    line = string.gsub ( line , "ğƒ¡", "\\isz" )
    line = string.gsub ( line , "ğƒ¢", "\\isn" )
    line = string.gsub ( line , "ğƒ£", "\\isp" )
    line = string.gsub ( line , "ğƒ¤", "\\isB" )
    line = string.gsub ( line , "ğƒ¥", "\\isG" )
    line = string.gsub ( line , "ğƒ¦", "\\isD" )
    line = string.gsub ( line , "ğƒ§", "\\isK" )
    line = string.gsub ( line , "ğƒ¨", "\\isZ" )
    line = string.gsub ( line , "ğƒ©", "\\apa" )
    line = string.gsub ( line , "ğƒª", "\\avu" )
    line = string.gsub ( line , "ğƒ«", "\\aga" )
    line = string.gsub ( line , "ğƒ¬", "\\adi" )
    line = string.gsub ( line , "ğƒ­", "\\ake" )
    line = string.gsub ( line , "ğƒ®", "\\azo" )
    line = string.gsub ( line , "ğƒ¯", "\\ani" )
    return ( line )
end
\end{luacode}

%% TeX-side code
\newenvironment{NeumeParseUnicode}{%
   \directlua{luatexbase.add_to_callback(
              "process_input_buffer",
              sometexttocommand, "sometexttocommand")}}{%
   \directlua{luatexbase.remove_from_callback(
              "process_input_buffer",
              "sometexttocommand")}}
