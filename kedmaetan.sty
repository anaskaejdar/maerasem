% Áelou! Káevarju dúing?  This is my first package ever and if it is
% beneficial to you, then I am very happy, my frjénding.
%
% (c) Anastázius Kaejatí Darián
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{kedmaetan}
\RequirePackage{setspace,dialogue,lettrine,needspace,changepage,ifthen}

\@ifpackageloaded{xcolor}{\providecommand\ruh{\color{red}}}{}
\@ifpackageloaded{luacolor}{\providecommand\ruh{\color{red}}}{}
\providecommand\ruh{}

\@ifpackageloaded{ekdosis}{
  \newenvironment{cleanalignment}{
    \setlength\linenumbersep{\maxdimen}\SetLineation{lineation=page,modulo,modulonum=100}
    \newenvironment{leftside}{\begin{edition*}}{\end{edition*}}
    \newenvironment{rightside}{\begin{translation}}{\end{translation}}
      \providecommand\resumeleftsidetext{--- Resume on the left page ---}
      \providecommand\resumeleftside{
        \begin{leftside}
        \end{leftside}
        \begin{rightside}
          \vbox to -\parskip {
            \decree{
              \resumeleftsidetext
            }
          }
        \end{rightside}
      }
    \begin{alignment}
    }{
      \resumeleftside
    \end{alignment}
  }
}{}

\@ifpackageloaded{fancyhdr}{
  \pagestyle{fancy}
  \fancyhf{}
  \fancyhead[LE,RO]{\thepage}
  \renewcommand{\headrule}{
    \vspace{-2ex}
    \hbox to\headwidth{
      \ruh\leaders\hrule height \headrulewidth\hfill
    }
  }
}{}

\@ifpackageloaded{psaltiki}{
  \providecommand\mart[1]{\vbox to 0.7\baselineskip{\vfil\hbox to 1em{\hfill\ruh\neume #1\hfill}\vfil}}
}{}
\providecommand\helper[1]{{\ruh\scshape\MakeLowercase{#1}}}
\providecommand\respond[1]{{\setlength\parindent{0.5\parindent}\ \\\indent\indent\helper{ #1: }\indent}}
\providecommand\doubare[1][2]{\helper{(#1x)}}
\providecommand\decree[1]{{
  \Needspace*{6\baselineskip}
  \setstretch{0.6}\vspace{-0.5\parskip}
  \begin{center}\helper{#1}\end{center}
  \vspace{-2.0\parskip}
}}
\providecommand\irmos[1]{\footnotesize(Irmos: \emph{#1})}
\providecommand\automelon[1]{\footnotesize(Automelon: \emph{#1})}
\def\drop #1#2 {
  \ifcat\noexpand\relax\noexpand#1\def\next{#1{#2}\drop}\else
  \def\next{\Needspace*{3\baselineskip}\lettrine{\ruh#1}{#2} }\fi
  \next
}
\newenvironment{haemsaefhe}{
  \noindent\begin{minipage}{\textwidth}
  }{
  \end{minipage}
}
\providecommand\gotoevenpage{
  \checkoddpage
  \ifthenelse{\boolean{oddpage}}{\hfill\newpage}{}
}
\let\olddialogue\dialogue \let\endolddialogue\enddialogue
\renewenvironment{dialogue}{
  \let\OldDialogueLabel\DialogueLabel
  \renewcommand*\DialogueLabel[1]{\helper{##1:}\hfil}
  \olddialogue
  \setlength\parskip{0.5em}
  }{
  \endolddialogue
}
\newcounter{versenumber}
\newenvironment{chantverses}{
  \setcounter{versenumber}{0}
  \noindent\begin{minipage}{\textwidth}
    \def\chantverse##1{##1}
    \renewcommand\chantverse[1]{
      \refstepcounter{versenumber}
      \speak{\nth{\theversenumber} Verse}\emph{##1}
    }
    \begin{dialogue}
      \setlength\parskip{0em}
    }{
    \end{dialogue}
  \end{minipage}
}
\providecommand\speak[2]{
  \vspace{0.3\baselineskip}
  \Needspace*{4\baselineskip}
  \noindent\hspace{0em}\helper{#1:}\hspace{0.5em}{\em #2}
  \nopagebreak
}
\providecommand\nearbelow{\vspace{-\parskip}}
\providecommand\nb{\nearbelow}
\providecommand\ndrop{\nearbelow\drop}

\setlength\parskip{1em}
